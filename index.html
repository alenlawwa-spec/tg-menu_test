<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Navigation</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram WebApp (defer –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏) -->
    <script src="https://telegram.org/js/telegram-web-app.js" defer></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase (–û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ 10.13.1) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js" defer></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-color: #00f2ff;
            --neon-pink: #ff007a;
            --neon-green: #39ff14;
            --neon-yellow: #ffea00;
        }

        html {
            overscroll-behavior: none; /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç—Å–∫–æ–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #050505;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            position: fixed;
            /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç—Å–∫–æ–∫–∞ */
            overscroll-behavior: none;
            /* –ó–ê–©–ò–¢–ê –ö–û–ù–¢–ï–ù–¢–ê */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ */
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
        }

        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 20% 30%, #1a1033 0%, #050505 50%);
            pointer-events: none;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px); /* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –°–Ω–∏–∂–µ–Ω –±–ª—é—Ä */
            opacity: 0.3;
            animation: float 15s infinite alternate ease-in-out;
            will-change: transform; /* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: GPU */
            transform: translateZ(0);
        }

        .orb-1 { width: 300px; height: 300px; background: var(--neon-color); top: -80px; right: -40px; }
        .orb-2 { width: 250px; height: 250px; background: var(--neon-pink); bottom: -60px; left: -40px; animation-delay: -3s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        .status-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
            transition: all 0.5s ease;
        }

        .status-dot.online {
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green);
            animation: pulse-green 2s infinite;
        }

        .status-dot.offline {
            animation: pulse-gray 2s infinite;
        }

        @keyframes pulse-green {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes pulse-gray { 0% { opacity: 0.5; } }

        /* –ê–ù–ò–ú–ê–¶–ò–Ø –£–°–ü–ï–•–ê */
        @keyframes flashGreen {
            0% { background-color: rgba(57, 255, 20, 0.3); border-color: var(--neon-green); }
            100% { background-color: rgba(255, 255, 255, 0.03); border-color: transparent; }
        }
        
        .flash-success {
            animation: flashGreen 1s ease-out;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s ease; /* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø */
            overflow-y: auto;
            /* –ò–∑–æ–ª—è—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ */
            overscroll-behavior-y: contain; 
            padding: 24px 20px calc(40px + env(safe-area-inset-bottom));
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            will-change: transform, opacity;
            content-visibility: auto; /* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø */
        }

        .page::-webkit-scrollbar { width: 0px; }

        .hidden-left { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .hidden-right { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .hidden-bottom { transform: translateY(100%); opacity: 0; pointer-events: none; }
        .active { transform: translateX(0); opacity: 1; pointer-events: all; }
        .active-modal { transform: translateY(0); opacity: 1; pointer-events: all; }

        .glass-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(12px); /* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –°–Ω–∏–∂–µ–Ω–æ —Å 20px */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 22px;
            transition: transform 0.2s, background 0.2s;
            position: relative;
            transform: translateZ(0); /* Hack –¥–ª—è GPU */
        }

        .glass-card:active {
            transform: scale(0.98);
            border-color: rgba(0, 242, 255, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        .admin-card {
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid rgba(0, 242, 255, 0.15);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .admin-section-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--neon-color);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-section-title::after {
            content: '';
            height: 1px;
            flex: 1;
            background: linear-gradient(90deg, rgba(0, 242, 255, 0.3), transparent);
        }

        .guide-item-admin {
            background: rgba(255, 255, 255, 0.03);
            border-left: 2px solid var(--neon-pink);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
            transition: background-color 0.3s;
        }

        .admin-input, .admin-textarea {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .admin-textarea {
            resize: vertical;
            min-height: 60px;
        }

        .admin-label {
            font-size: 10px;
            color: #777;
            margin-bottom: 4px;
            margin-left: 4px;
            display: block;
            text-transform: uppercase;
        }

        .admin-select {
            width: 100%;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .icon-picker-btn {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-picker-btn.active {
            border-color: var(--neon-color);
            background: rgba(0, 242, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
        }

        .icon-picker-btn svg { width: 18px; height: 18px; }

        .color-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .color-picker-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .color-picker-btn.active {
            transform: scale(1.2);
            border-color: white;
        }

        .btn-delete-icon {
            color: rgba(255, 77, 77, 0.6);
            padding: 4px;
        }

        .btn-add-cyber {
            background: rgba(0, 242, 255, 0.05);
            color: var(--neon-color);
            border: 1px dashed rgba(0, 242, 255, 0.4);
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-save-cyber {
            background: linear-gradient(135deg, #0066ff, #00f2ff);
            color: white;
            font-weight: 700;
            padding: 14px;
            border-radius: 15px;
            width: 100%;
            margin-top: 10px;
            text-transform: uppercase;
        }
        
        .btn-save-cyber:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .btn-edit-list {
            background: rgba(255, 0, 122, 0.1);
            color: var(--neon-pink);
            border: 1px solid rgba(255, 0, 122, 0.3);
            border-radius: 10px;
            padding: 8px;
            width: 100%;
            font-size: 12px;
            margin-top: 5px;
        }

        .icon-box {
            width: 54px;
            height: 54px;
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 4px 4px 12px rgba(0,0,0,0.3);
            margin-right: 18px;
            flex-shrink: 0;
        }

        .icon-box svg { width: 26px; height: 26px; }

        .title-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #a1a1a1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Styles for Category Chips */
        .category-scroll-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 12px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .category-scroll-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .category-chip {
            white-space: nowrap;
            padding: 6px 16px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
            color: #ccc;
        }

        .category-chip.active {
            background: rgba(0, 242, 255, 0.15);
            color: var(--neon-color);
            border-color: rgba(0, 242, 255, 0.4);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-bottom: 80px;
        }

        .gallery-item {
            aspect-ratio: 3/4;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            background: #111;
        }

        .gallery-item:active { transform: scale(0.96); }

        .gallery-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            will-change: opacity;
        }

        .gallery-overlay {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 50%;
        }

        #gallery-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.98);
            backdrop-filter: blur(15px);
            z-index: 200;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #gallery-modal.active-modal {
            opacity: 1;
            pointer-events: all;
        }

        .gallery-modal-img-container {
            width: 100%;
            height: 55vh;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .gallery-modal-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .gallery-modal-content {
            flex-grow: 1;
            background: linear-gradient(to bottom, rgba(20, 20, 25, 1), rgba(10, 10, 15, 1));
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 24px 20px 100px 20px;
            display: flex;
            flex-direction: column;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            margin-top: -24px;
            position: relative;
            z-index: 10;
            overflow-y: auto;
            /* –ò–∑–æ–ª—è—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ */
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
        }

        .quote-block {
            border-left: 3px solid var(--neon-pink);
            padding-left: 16px;
            margin-bottom: 16px;
            font-style: italic;
            color: #ccc;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .btn-copy {
            position: fixed;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: rgba(255, 0, 122, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 14px;
            border-radius: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 210;
            transition: transform 0.1s;
        }
        
        .btn-copy:active { transform: scale(0.96); }

        .magic-btn {
            background: linear-gradient(135deg, #7b2ff7, #2f88f7);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .magic-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--neon-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            z-index: 5;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .review-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .review-name { font-weight: 600; color: var(--neon-color); font-size: 14px; }
        .review-date { font-size: 10px; color: #888; }
        .review-text { font-size: 13px; line-height: 1.4; color: #ddd; word-wrap: break-word; }
        .stars { color: var(--neon-yellow); font-size: 12px; letter-spacing: 2px; }

        .btn-write-review {
            background: linear-gradient(90deg, #ff007a, #7b2ff7);
            color: white;
            font-weight: 600;
            padding: 14px;
            border-radius: 14px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(255, 0, 122, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        #review-write-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.95);
            backdrop-filter: blur(10px);
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 24px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
        }

        #review-write-modal.active-modal {
            opacity: 1;
            pointer-events: all;
        }

        .star-rating-input {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .star-rating-input input { display: none; }

        .star-rating-input label {
            font-size: 32px;
            color: #444;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating-input input:checked ~ label,
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label {
            color: var(--neon-yellow);
            text-shadow: 0 0 10px var(--neon-yellow);
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –¢–û–í–ê–†–û–í (PRODUCTS) --- */
        .product-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 22px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }
        .product-card:active { transform: scale(0.97); }

        .product-image {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .product-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            backdrop-filter: blur(4px);
            z-index: 2;
        }
        .badge-sold { background: rgba(0, 0, 0, 0.6); color: #aaa; border: 1px solid #555; }
        .badge-wait { background: rgba(255, 165, 0, 0.2); color: orange; border: 1px solid orange; }
        .badge-order { background: rgba(0, 242, 255, 0.2); color: var(--neon-color); border: 1px solid var(--neon-color); }

        .product-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-title {
            font-weight: 600;
            font-size: 13px;
            line-height: 1.3;
            margin-bottom: 4px;
            color: white;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-desc-short {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .price-block {
            margin-top: auto;
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .price-new {
            color: var(--neon-color);
            font-weight: 700;
            font-size: 15px;
        }
        .price-old {
            color: #555;
            font-size: 11px;
            text-decoration: line-through;
        }

        /* Modal Product Slider */
        .product-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            gap: 10px;
            padding-bottom: 10px;
        }
        .product-slider::-webkit-scrollbar { display: none; }
        
        .product-slide {
            flex: 0 0 100%;
            scroll-snap-align: center;
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 1/1;
            background: #000;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .product-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* –ò–ª–∏ contain, –µ—Å–ª–∏ –Ω–∞–¥–æ —Ü–µ–ª–∏–∫–æ–º */
        }
        
        #product-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5,5,8,0.98);
            z-index: 250;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 0;
            overflow-y: auto;
        }
        #product-modal.active-modal { transform: translateY(0); }

    </style>
</head>
<body>
    <div class="bg-glow">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <div class="status-container">
        <div id="status-dot" class="status-dot offline"></div>
    </div>

    <div id="main-page" class="page active">
        <header class="mb-10 mt-4 text-center">
            <h1 id="nav-header" class="text-3xl font-bold title-gradient tracking-tight select-none cursor-pointer">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h1>
            <p id="nav-subheader" class="text-gray-500 text-sm mt-2">–¢–≤–æ–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É</p>
        </header>

        <div id="main-menu-container" class="grid gap-4"></div>

        <footer class="mt-auto pt-16 pb-8 text-center">
            <p class="text-[10px] text-gray-600 opacity-50">Developed by Elena Sotnikova</p>
        </footer>
    </div>

    <div id="sub-page" class="page hidden-right">
        <header class="mb-6 mt-4 text-center relative">
             <button onclick="hideSubPage()" class="absolute left-0 top-1 text-2xl opacity-50 p-2">‚Äπ</button>
            <h1 id="sub-page-title" class="text-2xl font-bold title-gradient tracking-tight text-blue-400">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h1>
            <p id="sub-page-subtitle" class="text-gray-500 text-xs mt-1">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</p>
        </header>
        <div id="sub-page-container"></div>
        <div class="mt-auto h-20"></div> 
    </div>

    <div id="gallery-modal">
        <button onclick="closeGalleryModal()" class="absolute top-4 right-4 z-50 w-10 h-10 bg-black/50 rounded-full text-white flex items-center justify-center backdrop-blur-md">‚úï</button>
        <div class="gallery-modal-img-container" id="modal-img-wrapper"></div>
        <div class="gallery-modal-content">
            <div class="modal-text-wrapper">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 font-bold flex-shrink-0">PROMPT TEXT</div>
                <div class="quote-block" id="modal-prompt-text"></div>
            </div>
            <button onclick="copyCurrentPrompt()" class="btn-copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç ‚ú®
            </button>
        </div>
    </div>

    <!-- NEW PRODUCT MODAL -->
    <div id="product-modal">
        <div class="relative w-full h-full flex flex-col">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 z-50 w-8 h-8 bg-black/50 rounded-full text-white flex items-center justify-center backdrop-blur-md">‚úï</button>
            
            <div class="p-4 pb-0 flex-shrink-0">
                <div class="product-slider" id="product-modal-slider">
                    <!-- –°–ª–∞–π–¥—ã JS -->
                </div>
                <div class="text-center text-[10px] text-gray-500 mt-2">–õ–∏—Å—Ç–∞–π —Ñ–æ—Ç–æ ‚Üí</div>
            </div>

            <div class="flex-grow p-5 flex flex-col overflow-y-auto">
                <h2 id="product-modal-title" class="text-2xl font-bold text-white mb-1"></h2>
                
                <div class="flex items-baseline gap-3 mb-4">
                    <span id="product-modal-price" class="text-xl text-[#00f2ff] font-bold"></span>
                    <span id="product-modal-old-price" class="text-sm text-gray-500 line-through"></span>
                </div>

                <div class="w-full h-[1px] bg-white/10 mb-4"></div>

                <p id="product-modal-desc" class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap pb-20"></p>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black via-black/90 to-transparent">
                <button id="product-buy-btn" class="btn-save-cyber shadow-[0_0_20px_rgba(0,242,255,0.3)]">
                    <!-- Text via JS -->
                </button>
            </div>
        </div>
    </div>

    <div id="review-write-modal">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-white mb-2">–í–∞—à –æ—Ç–∑—ã–≤</h2>
            <p class="text-gray-400 text-xs">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏</p>
        </div>
        
        <label class="admin-label">–í–∞—à–µ –∏–º—è</label>
        <input type="text" id="review-name-input" class="admin-input bg-white/10" placeholder="–ò–º—è">
        
        <div class="star-rating-input">
            <input type="radio" id="star5" name="rating" value="5"><label for="star5">‚òÖ</label>
            <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÖ</label>
            <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÖ</label>
            <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÖ</label>
            <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÖ</label>
        </div>
        
        <textarea id="review-text-input" class="admin-textarea bg-white/10 mb-6" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–∏—è—Ç–Ω–æ–µ..."></textarea>
        
        <button onclick="submitReview()" class="btn-save-cyber">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ‚ú®</button>
        <button onclick="closeReviewModal()" class="text-gray-500 text-sm mt-4">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="admin-page" class="page hidden-bottom" style="background: rgba(5,5,8,0.98); z-index: 50; padding-bottom: 100px;">
        <header class="mb-8 flex justify-between items-center sticky top-0 bg-[#050508] py-4 z-20 border-b border-white/5">
            <div>
                <h2 class="text-2xl font-bold text-white tracking-tight">Terminal</h2>
                <div class="text-[10px] text-cyan-400 font-mono">ACCESS GRANTED // ADMIN_MODE</div>
            </div>
            <div class="flex gap-2">
                <button onclick="openModeration()" class="bg-blue-900/30 border border-blue-500/30 text-blue-400 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è</button>
                <button onclick="closeAdmin()" class="bg-white/5 w-10 h-10 rounded-full flex items-center justify-center text-gray-400">‚úï</button>
            </div>
        </header>

        <div id="admin-content-main" class="z-10">
            <div class="admin-card">
                <div class="admin-section-title">–ó–∞–≥–æ–ª–æ–≤–∫–∏ –ì–ª–∞–≤–Ω–æ–π</div>
                <div class="mb-2">
                    <label class="admin-label">–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="admin-header-title" class="admin-input">
                </div>
                <div>
                    <label class="admin-label">–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="admin-header-subtitle" class="admin-input">
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-section-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é</div>
                <div id="admin-main-menu-list" class="space-y-4"></div>
                <button onclick="addNewMainMenuButton()" class="btn-add-cyber mt-4">
                    <span>‚ö°</span> –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                </button>
            </div>
            
            <button onclick="saveAdminData()" id="btn-save-global" class="btn-save-cyber mt-4 mb-8" style="box-shadow: 0 4px 20px rgba(0, 242, 255, 0.2);">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>

        <div id="admin-content-sublist" class="hidden z-10 pb-24">
            <button onclick="backToMainAdmin()" class="text-gray-400 text-xs mb-4 flex items-center gap-2">‚Äπ –ù–∞–∑–∞–¥</button>
            
            <div class="admin-card">
                <div class="admin-section-title text-pink-500" id="admin-sublist-title">–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ø–∏—Å–∫–∞</div>
                
                <button onclick="addNewSubItem()" class="btn-add-cyber mb-2"><span>+</span> –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</button>
                <button onclick="saveAdminData()" id="btn-save-sub" class="btn-save-cyber mb-6" style="margin-top: 0; box-shadow: 0 4px 20px rgba(0, 242, 255, 0.2);">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                
                <div id="admin-sublist-items" class="space-y-4"></div>
            </div>
        </div>

        <div id="admin-content-moderation" class="hidden z-10">
             <button onclick="backToMainAdmin()" class="text-gray-400 text-xs mb-4 flex items-center gap-2">‚Äπ –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
             <div class="admin-section-title text-yellow-400">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</div>
             <div id="moderation-list" class="space-y-4 pb-20"></div>
        </div>

        <div id="save-status" class="text-center text-xs text-cyan-400 mt-4 opacity-0 transition-opacity font-mono">DB_SYNC_COMPLETE</div>
    </div>

    <!-- Hidden canvas for image compression -->
    <canvas id="compress-canvas" style="display: none;"></canvas>

    <script>
        const ADMIN_ID = 758556732; 
        
        let isParsing = false;
        let tg; // Global variable for Telegram WebApp
        let availableCategories = new Set(); // –ö—ç—à –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∫–∏

        document.addEventListener('contextmenu', event => event.preventDefault());

        const ICON_LIBRARY = [
            { id: 'folder', svg: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>' },
            { id: 'star', svg: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>' },
            { id: 'bolt', svg: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>' },
            { id: 'message', svg: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>' },
            { id: 'book', svg: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>' },
            { id: 'zap', svg: '<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>' },
            { id: 'instagram', svg: '<rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>' },
            { id: 'youtube', svg: '<path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>' },
            { id: 'telegram', svg: '<path d="M21.198 2.433a2.242 2.242 0 0 0-1.022.215l-16.5 6.75c-.92.376-.91 1.055-.16 1.43l4.33 1.353 10.033-6.326c.475-.29.911-.134.555.182l-8.13 7.34-.316 4.478c.438 0 .633-.2.88-.44l2.12-2.058 4.408 3.254c.438-.448 1.4.217 1.6-.758l2.9-13.68c.273-1.08-.41-1.574-1.108-1.23z"></path>' },
            { id: 'globe', svg: '<circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>' },
            { id: 'gift', svg: '<polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>' },
            { id: 'award', svg: '<circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>' },
            { id: 'vk', svg: '<path d="M15.5 22H8.5C4.5 22 2 19.5 2 15.5V8.5C2 4.5 4.5 2 8.5 2H15.5C19.5 2 22 4.5 22 8.5V15.5C22 19.5 19.5 22 15.5 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.5 9.5C17.5 9.5 15.5 9.5 15 11.5C14.5 13.5 12.5 13 12.5 13V10.5C12.5 10.5 12.5 9.5 10.5 9.5C8.5 9.5 7.5 11.5 7.5 11.5C7.5 11.5 6 13.5 6 16.5C6 19.5 8 20.5 8 20.5H9.5C9.5 20.5 10 20 10 19C10 18 10.5 17 11.5 17C12.5 17 13 19 14.5 20.5C16 22 16.5 20.5 16.5 20.5H18C18 20.5 19 20 18 18.5C17 17 15.5 16 15.5 16C15.5 16 17.5 15 18 13.5C18.5 12 17.5 9.5 17.5 9.5Z" fill="currentColor"/>' },
            { id: 'rutube', svg: '<path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5"/><path d="M9.5 8L16 12L9.5 16V8Z" fill="currentColor"/>' }
        ];

        const COLOR_LIBRARY = [
            { id: 'text-blue-400', hex: '#00f2ff' },
            { id: 'text-pink-500', hex: '#ff007a' },
            { id: 'text-green-400', hex: '#39ff14' },
            { id: 'text-yellow-400', hex: '#ffea00' },
            { id: 'text-white', hex: '#ffffff' }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyCiYBslwEecbyuMyW5J05nvTs_sXLlurR4",
            authDomain: "tg-menu.firebaseapp.com",
            projectId: "tg-menu",
            storageBucket: "tg-menu.firebasestorage.app",
            messagingSenderId: "754545603793",
            appId: "1:754545603793:web:a466fd9b21a298a69d41f0"
        };

        const configDocId = "main_nav_v4_pro"; 
        let db, auth;
        let appData = { headerTitle: "–ù–∞–≤–∏–≥–∞—Ü–∏—è", headerSubtitle: "–¢–≤–æ–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫", mainMenu: [] };

        // Initialize App once DOM is ready to ensure deferred scripts are loaded
        document.addEventListener('DOMContentLoaded', () => {
            initTelegram();
            initApp();
        });

        function initTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.expand();
                
                // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–≤–∞–π–ø–æ–≤ (–∑–∞–∫—Ä—ã—Ç–∏–µ)
                if (tg.disableVerticalSwipes) {
                    tg.disableVerticalSwipes();
                }

                tg.ready();
                
                // Set up back button listener
                tg.BackButton.onClick(() => {
                    const galleryModal = document.getElementById('gallery-modal');
                    const productModal = document.getElementById('product-modal');
                    
                    if (galleryModal.classList.contains('active-modal')) {
                        closeGalleryModal();
                    } else if (productModal.classList.contains('active-modal')) {
                        closeProductModal();
                    } else {
                        hideSubPage();
                    }
                });
            } else {
                console.warn('Telegram WebApp environment not found. Using fallback mock.');
                // Mock object for browser testing
                tg = {
                    initDataUnsafe: { user: { id: 0, first_name: "BrowserUser" } },
                    expand: () => {},
                    ready: () => {},
                    disableVerticalSwipes: () => {}, // Mock
                    HapticFeedback: { 
                        impactOccurred: () => {}, 
                        notificationOccurred: () => {}, 
                        selectionChanged: () => {} 
                    },
                    BackButton: { 
                        show: () => {}, 
                        hide: () => {}, 
                        onClick: () => {} 
                    },
                    openLink: (url) => window.open(url, '_blank'),
                    openTelegramLink: (url) => window.open(url, '_blank'),
                    showAlert: (msg) => alert(msg),
                    showPopup: (params, callback) => { if(callback) callback('ok'); }
                };
            }
        }

        async function initApp() {
            // --- 1. –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–ê–ì–†–£–ó–ö–ê –ò–ó –ö–≠–®–ê ---
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫—ç—à–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ú–ì–ù–û–í–ï–ù–ù–û
            const cachedData = localStorage.getItem('cyber_nav_cache_' + configDocId);
            if (cachedData) {
                try {
                    appData = JSON.parse(cachedData);
                    updateUI(); // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ä–∞–∑—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å —Å–µ—Ç–∏
                    console.log("–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –∫—ç—à–∞ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)");
                } catch(e) {
                    console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞", e);
                }
            }

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            
            // --- FIX: Force Long Polling to avoid timeouts ---
            db.settings({
                experimentalForceLongPolling: true,
                host: "firestore.googleapis.com",
                ssl: true
            });
            
            // --- –í–ê–ñ–ù–û: –í–ö–õ–Æ–ß–ê–ï–ú OFFLINE PERSISTENCE –î–û –ó–ê–ü–†–û–°–û–í ---
            try {
                await db.enablePersistence({ synchronizeTabs: true });
                console.log("üî• Offline Persistence: ACTIVATED");
            } catch (err) {
                console.warn("Offline Persistence Error:", err.code);
            }
            
            auth = firebase.auth();
            
            // --- 2. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –°–ï–¢–¨ (–§–û–ù–û–í–´–ô –†–ï–ñ–ò–ú) ---
            // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI –æ–∂–∏–¥–∞–Ω–∏–µ–º await, –µ—Å–ª–∏ –∫—ç—à –±—ã–ª. 
            // –ù–æ –µ—Å–ª–∏ –∫—ç—à–∞ –Ω–µ –±—ã–ª–æ (–ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥) - –ø—Ä–∏–¥–µ—Ç—Å—è –∂–¥–∞—Ç—å, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –ø—É—Å—Ç–æ.
            if (!cachedData) {
                 try {
                    await auth.signInAnonymously();
                 } catch (e) {
                     console.error("Auth failed", e);
                 }
            } else {
                 // –ï—Å–ª–∏ –∫—ç—à –µ—Å—Ç—å, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ, –Ω–µ —Ç–æ—Ä–º–æ–∑—è —Å–∫—Ä–∏–ø—Ç
                 auth.signInAnonymously().catch(e => console.error(e));
            }
            
            db.collection('configs').doc(configDocId).onSnapshot((doc) => {
                if (doc.exists) {
                    appData = doc.data();
                    // --- 3. –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ö–≠–® ---
                    localStorage.setItem('cyber_nav_cache_' + configDocId, JSON.stringify(appData));
                    
                    updateUI();
                    setOnlineStatus(true);
                }
            });
        }

        function setOnlineStatus(online) {
            const dot = document.getElementById('status-dot');
            if (dot) dot.className = `status-dot ${online ? 'online' : 'offline'}`;
        }

        function updateUI() {
            document.getElementById('nav-header').textContent = appData.headerTitle;
            document.getElementById('nav-subheader').textContent = appData.headerSubtitle;
            renderMainMenu();
        }

        function renderMainMenu() {
            const container = document.getElementById('main-menu-container');
            container.innerHTML = '';
            (appData.mainMenu || []).forEach((btn) => {
                const isComplexMode = btn.mode === 'list' || btn.mode === 'gallery' || btn.mode === 'reviews' || btn.mode === 'products';
                
                const btnEl = document.createElement('div');
                btnEl.className = 'glass-card p-4 flex items-center cursor-pointer';
                btnEl.onclick = () => isComplexMode ? openSubPage(btn) : handleLink(btn.directLink);

                const iconSvg = ICON_LIBRARY.find(i => i.id === btn.iconId)?.svg || ICON_LIBRARY[2].svg;
                
                btnEl.innerHTML = `
                    <div class="icon-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="${btn.iconColor || 'text-white'}">
                            ${iconSvg}
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-white">${btn.title}</h3>
                        <p class="text-gray-400 text-xs text-white/60">${btn.subtitle}</p>
                    </div>
                    <div class="opacity-30 text-xl">‚Ä∫</div>
                `;
                container.appendChild(btnEl);
            });
        }

        // --- –õ–û–ì–ò–ö–ê –°–í–ê–ô–ü–ê ---
        let touchStartX = 0;
        const subPage = document.getElementById('sub-page');

        subPage.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        subPage.addEventListener('touchmove', e => {}, { passive: true });

        subPage.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].screenX;
            if (touchEndX - touchStartX > 50) {
                hideSubPage();
            }
        }, { passive: true });

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function loadReviews(container) {
            const reviewsList = document.createElement('div');
            reviewsList.id = 'reviews-public-list';
            reviewsList.innerHTML = '<div class="text-center mt-10"><div class="spinner relative left-1/2 -ml-5"></div></div>';
            container.appendChild(reviewsList);

            db.collection('reviews').where('approved', '==', true).get().then(snap => {
                reviewsList.innerHTML = '';
                const docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => new Date(b.date) - new Date(a.date));
                
                if(docs.length === 0) {
                    reviewsList.innerHTML = '<div class="text-center text-gray-500 text-sm mt-4">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</div>';
                    return;
                }

                docs.forEach(r => {
                    const card = document.createElement('div');
                    card.className = 'review-card animate-pulse-enter';
                    const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5 - r.rating);
                    const dateStr = new Date(r.date).toLocaleDateString();
                    card.innerHTML = `
                        <div class="review-header">
                            <span class="review-name">${escapeHtml(r.name)}</span>
                            <span class="stars">${stars}</span>
                        </div>
                        <div class="review-text">${escapeHtml(r.text)}</div>
                        <div class="review-date mt-2 text-right opacity-50 text-[9px]">${dateStr}</div>
                    `;
                    reviewsList.appendChild(card);
                });
            });
        }

        function openSubPage(btnData) {
            tg.HapticFeedback.impactOccurred('medium');
            document.getElementById('sub-page-title').textContent = btnData.title;
            document.getElementById('sub-page-subtitle').textContent = btnData.subtitle;
            const container = document.getElementById('sub-page-container');
            container.innerHTML = '';

            if (btnData.mode === 'gallery') {
                const allItems = btnData.items || [];
                const categories = ['–í—Å–µ', ...new Set(allItems.map(i => i.category).filter(Boolean))];
                
                if (categories.length > 1) {
                    const filterContainer = document.createElement('div');
                    filterContainer.className = 'category-scroll-container';
                    
                    categories.forEach(cat => {
                        const chip = document.createElement('div');
                        chip.className = `category-chip ${cat === '–í—Å–µ' ? 'active' : ''}`;
                        chip.textContent = cat;
                        chip.onclick = (e) => {
                            document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
                            e.target.classList.add('active');
                            renderGalleryItems(cat === '–í—Å–µ' ? allItems : allItems.filter(i => i.category === cat), gridContainer);
                            tg.HapticFeedback.selectionChanged();
                        };
                        filterContainer.appendChild(chip);
                    });
                    container.appendChild(filterContainer);
                }

                const gridContainer = document.createElement('div');
                gridContainer.className = 'gallery-grid animate-pulse-enter';
                container.appendChild(gridContainer);
                renderGalleryItems(allItems, gridContainer);
            } 
            else if (btnData.mode === 'products') {
                const gridContainer = document.createElement('div');
                gridContainer.className = 'gallery-grid pb-24'; // Reuse gallery grid structure (2 col)
                container.appendChild(gridContainer);
                renderProductItems(btnData.items || [], gridContainer);
            }
            else if (btnData.mode === 'reviews') {
                container.className = 'flex flex-col pb-20';
                const btn = document.createElement('button');
                btn.className = 'btn-write-review';
                btn.innerHTML = '‚ú® –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤';
                btn.onclick = openReviewModal;
                container.appendChild(btn);
                loadReviews(container);
            }
            else {
                // –†–ï–ñ–ò–ú –°–ü–ò–°–ö–ê: –ß–ò–°–¢–´–ô –°–¢–ò–õ–¨ –ë–ï–ó –°–ú–ê–ô–õ–ò–ö–û–í
                container.className = 'grid gap-4'; 
                (btnData.items || []).forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'glass-card p-4 flex items-center cursor-pointer';
                    itemEl.onclick = () => handleLink(item.link);
                    // –£–ë–†–ê–ù ICON-BOX –ü–û –¢–ó
                    itemEl.innerHTML = `<div class="flex-1 text-white font-medium pl-2">${item.title}</div><div class="opacity-30 text-xl">‚Ä∫</div>`;
                    container.appendChild(itemEl);
                });
            }

            document.getElementById('main-page').classList.replace('active', 'hidden-left');
            subPage.classList.replace('hidden-right', 'active');
            tg.BackButton.show();
        }

        // --- –£–õ–£–ß–®–ï–ù–ù–´–ô –†–ï–ù–î–ï–† –ì–ê–õ–ï–†–ï–ò –° –õ–ï–ß–ï–ù–ò–ï–ú –°–°–´–õ–û–ö ---
        function renderGalleryItems(items, container) {
            container.innerHTML = '';
            items.forEach((item, idx) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'gallery-item cursor-pointer animate-pulse-enter';
                itemEl.onclick = () => openGalleryModal(item.imageUrl, item.prompt);
                
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï –î–ò–ó–ê–ô–ù–ê –§–û–¢–û (–£–±—Ä–∞–Ω–∞ —Ä–æ–∑–æ–≤–∞—è –Ω–∞–¥–ø–∏—Å—å –∏ —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞)
                const overlay = item.title ? `
                    <div class="gallery-overlay pointer-events-none">
                        <div class="text-white text-xs font-semibold truncate">${escapeHtml(item.title)}</div>
                    </div>
                ` : '';
                
                // –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (tryRepairImage) –∏ –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (loading="lazy")
                // data-tg-link —Ö—Ä–∞–Ω–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                itemEl.innerHTML = `
                    <img src="${item.imageUrl}" 
                         data-tg-link="${item.tgLink || ''}"
                         class="gallery-img" 
                         referrerpolicy="no-referrer" 
                         loading="lazy"
                         decoding="async"
                         onerror="tryRepairImage(this)"
                    >
                    ${overlay}
                `;
                container.appendChild(itemEl);
            });
        }
        
        // --- –†–ï–ù–î–ï–† –¢–û–í–ê–†–û–í (PRODUCTS) ---
        function renderProductItems(items, container) {
            container.innerHTML = '';
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'product-card cursor-pointer animate-pulse-enter';
                card.onclick = () => openProductModal(item);

                // Badge Logic
                let badgeHtml = '';
                if(item.status === 'sold') badgeHtml = `<div class="product-badge badge-sold">–ü—Ä–æ–¥–∞–Ω–æ</div>`;
                else if(item.status === 'wait') badgeHtml = `<div class="product-badge badge-wait">–û–∂–∏–¥–∞–µ—Ç—Å—è</div>`;
                else if(item.status === 'order') badgeHtml = `<div class="product-badge badge-order">–ü–æ–¥ –∑–∞–∫–∞–∑</div>`;

                // Price Logic
                let priceHtml = '';
                if(item.oldPrice) {
                    priceHtml = `
                        <div class="price-block">
                            <span class="price-new">${item.price}</span>
                            <span class="price-old">${item.oldPrice}</span>
                        </div>
                    `;
                } else {
                    priceHtml = `<div class="price-block"><span class="price-new">${item.price}</span></div>`;
                }

                // Main Image (first in array or single field)
                const mainImg = (item.images && item.images.length > 0) ? item.images[0] : item.imageUrl;

                card.innerHTML = `
                    ${badgeHtml}
                    <img src="${mainImg || 'https://placehold.co/400'}" class="product-image" loading="lazy">
                    <div class="product-info">
                        <div class="product-title">${escapeHtml(item.title)}</div>
                        <div class="product-desc-short">${escapeHtml(item.description)}</div>
                        ${priceHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- –ú–ï–•–ê–ù–ò–ó–ú –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –ö–ê–†–¢–ò–ù–û–ö (PARSING ON THE FLY) ---
        const repairCache = new Set(); // –ö—ç—à, —á—Ç–æ–±—ã –Ω–µ –¥–æ–ª–±–∏—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –±–∏—Ç—ã–π —É—Ä–ª

        function tryRepairImage(imgEl) {
            const tgLink = imgEl.getAttribute('data-tg-link');
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç –∏–ª–∏ —É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏ —á–∏–Ω–∏—Ç—å - —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É –∏ —É—Ö–æ–¥–∏–º
            if (!tgLink || repairCache.has(tgLink)) {
                imgEl.src = 'https://placehold.co/400x600/222/555?text=Expired+Link';
                return;
            }

            repairCache.add(tgLink);
            console.log("–ü—ã—Ç–∞—é—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑:", tgLink);
            
            // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ "–ó–∞–≥—Ä—É–∑–∫–∞..."
            imgEl.style.opacity = '0.5';

            const embedUrl = tgLink + '?embed=1&mode=tme';
            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(embedUrl);

            fetch(proxyUrl)
                .then(res => { if(!res.ok) throw new Error(); return res.json(); })
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data.contents, "text/html");
                    const photoWrap = doc.querySelector('.tgme_widget_message_photo_wrap');
                    if (photoWrap) {
                        const style = photoWrap.getAttribute('style');
                        const bgMatch = style.match(/url\('?(.*?)'?\)/);
                        if (bgMatch) {
                            imgEl.src = bgMatch[1]; // –£—Å–ø–µ—Ö! –û–±–Ω–æ–≤–ª—è–µ–º src
                            imgEl.style.opacity = '1';
                            return;
                        }
                    }
                    throw new Error("No image found");
                })
                .catch(() => {
                    imgEl.src = 'https://placehold.co/400x600/222/555?text=Lost+Signal';
                    imgEl.style.opacity = '1';
                });
        }

        function hideSubPage() {
            subPage.classList.replace('active', 'hidden-right');
            document.getElementById('main-page').classList.replace('hidden-left', 'active');
            tg.BackButton.hide();
        }

        function handleLink(url) {
            if (!url) return;
            tg.HapticFeedback.impactOccurred('light');
            if (url.includes('t.me/')) {
                tg.openTelegramLink(url);
            } else {
                tg.openLink(url, { try_instant_view: true });
            }
        }

        function openReviewModal() {
            const nameInput = document.getElementById('review-name-input');
            const userFirstName = tg.initDataUnsafe?.user?.first_name || "–ì–æ—Å—Ç—å";
            if(!nameInput.value) nameInput.value = userFirstName;
            document.getElementById('review-write-modal').classList.add('active-modal');
        }

        function closeReviewModal() {
            document.getElementById('review-write-modal').classList.remove('active-modal');
        }

        function submitReview() {
            const name = document.getElementById('review-name-input').value;
            const text = document.getElementById('review-text-input').value;
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            
            if(!ratingEl) return tg.showAlert("–ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É! ‚≠ê");
            if(!text) return tg.showAlert("–ù–∞–ø–∏—à–∏—Ç–µ —Ö–æ—Ç—å –ø–∞—Ä—É —Å–ª–æ–≤...");
            
            const rating = parseInt(ratingEl.value);
            
            db.collection('reviews').add({
                name: name,
                text: text,
                rating: rating,
                approved: false, 
                date: new Date().toISOString(),
                userId: tg.initDataUnsafe?.user?.id || 'anon'
            }).then(() => {
                closeReviewModal();
                tg.showAlert("–í–∞—à –æ—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é! ‚ú®");
                document.getElementById('review-text-input').value = '';
                document.querySelectorAll('input[name="rating"]').forEach(el => el.checked = false);
            });
        }

        function openGalleryModal(imgUrl, promptText) {
            tg.HapticFeedback.impactOccurred('medium');
            const modal = document.getElementById('gallery-modal');
            const wrapper = document.getElementById('modal-img-wrapper');
            wrapper.innerHTML = '';

            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            wrapper.appendChild(spinner);

            const img = document.createElement('img');
            img.src = imgUrl;
            img.className = "gallery-modal-img";
            img.referrerPolicy = "no-referrer";
            img.style.opacity = "0";
            img.onload = () => {
                spinner.remove();
                img.style.transition = "opacity 0.3s";
                img.style.opacity = "1";
            };
            img.onerror = function() {
                spinner.remove();
                this.src = 'https://placehold.co/400x600/222/555?text=Error+Loading';
                this.style.opacity = "1";
            };
            wrapper.appendChild(img);
            
            const grad = document.createElement('div');
            grad.className = "absolute bottom-0 inset-x-0 h-24 bg-gradient-to-t from-[#141419] to-transparent pointer-events-none";
            wrapper.appendChild(grad);

            document.getElementById('modal-prompt-text').textContent = promptText || "–ù–µ—Ç –ø—Ä–æ–º–ø—Ç–∞";
            modal.classList.add('active-modal');
        }

        function closeGalleryModal() {
            document.getElementById('gallery-modal').classList.remove('active-modal');
            setTimeout(() => {
                 document.getElementById('modal-img-wrapper').innerHTML = '';
            }, 300);
        }

        // --- PRODUCT MODAL LOGIC ---
        function openProductModal(item) {
            tg.HapticFeedback.impactOccurred('medium');
            
            // Populate Content
            document.getElementById('product-modal-title').textContent = item.title;
            document.getElementById('product-modal-desc').textContent = item.fullDescription || item.description;
            
            // Price
            document.getElementById('product-modal-price').textContent = item.price;
            const oldPriceEl = document.getElementById('product-modal-old-price');
            if (item.oldPrice) {
                oldPriceEl.textContent = item.oldPrice;
                oldPriceEl.style.display = 'inline';
            } else {
                oldPriceEl.style.display = 'none';
            }

            // Slider
            const slider = document.getElementById('product-modal-slider');
            slider.innerHTML = '';
            const images = (item.images && item.images.length > 0) ? item.images : [item.imageUrl];
            
            images.forEach(imgUrl => {
                if(!imgUrl) return;
                const slide = document.createElement('div');
                slide.className = 'product-slide';
                slide.innerHTML = `<img src="${imgUrl}" loading="lazy">`;
                slider.appendChild(slide);
            });

            // Button
            const btn = document.getElementById('product-buy-btn');
            btn.textContent = item.buttonText || "–ö—É–ø–∏—Ç—å";
            btn.onclick = () => {
                tg.HapticFeedback.notificationOccurred('success');
                // Open telegram DM with preset text
                if (item.buttonLink) {
                    const cleanLink = item.buttonLink.replace('https://t.me/', '').replace('@', '');
                    const text = `–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å: ${item.title}`;
                    const fullUrl = `https://t.me/${cleanLink}?text=${encodeURIComponent(text)}`;
                    tg.openTelegramLink(fullUrl);
                } else {
                    tg.showAlert("–°–≤—è–∑—å —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞");
                }
            };

            document.getElementById('product-modal').classList.add('active-modal');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active-modal');
        }

        function copyCurrentPrompt() {
            const text = document.getElementById('modal-prompt-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                tg.showAlert('–ü—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                tg.HapticFeedback.notificationOccurred('success');
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                tg.showAlert('–ü—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            });
        }

        // --- –ê–î–ú–ò–ù–ö–ê ---
        let tapCount = 0;
        document.getElementById('nav-header').addEventListener('click', () => {
            tapCount++;
            if (tapCount >= 5) {
                if (tg.initDataUnsafe?.user?.id !== ADMIN_ID) return;
                openAdmin(); 
                tapCount = 0;
            }
            setTimeout(() => tapCount = 0, 1000);
        });

        let tempAppData = null;
        let currentEditingIndex = null;

        function openAdmin() {
            tempAppData = JSON.parse(JSON.stringify(appData));
            document.getElementById('admin-header-title').value = tempAppData.headerTitle;
            document.getElementById('admin-header-subtitle').value = tempAppData.headerSubtitle;
            renderAdminMainMenu();
            document.getElementById('admin-page').classList.replace('hidden-bottom', 'active-modal');
            document.getElementById('admin-content-main').classList.remove('hidden');
            document.getElementById('admin-content-sublist').classList.add('hidden');
            document.getElementById('admin-content-moderation').classList.add('hidden');
        }

        function renderAdminMainMenu() {
            const list = document.getElementById('admin-main-menu-list');
            list.innerHTML = '';
            const total = tempAppData.mainMenu.length;
            tempAppData.mainMenu.forEach((btn, idx) => {
                const div = document.createElement('div');
                div.className = "guide-item-admin";

                const upBtn = idx > 0 ? `<button onclick="moveMainMenuButton(${idx}, -1)" class="px-2 text-gray-500 hover:text-cyan-400 transition">‚ñ≤</button>` : `<span class="px-2 opacity-0">‚ñ≤</span>`;
                const downBtn = idx < total - 1 ? `<button onclick="moveMainMenuButton(${idx}, 1)" class="px-2 text-gray-500 hover:text-cyan-400 transition">‚ñº</button>` : `<span class="px-2 opacity-0">‚ñº</span>`;

                let editBtnText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫";
                if (btn.mode === 'gallery') editBtnText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ì–ê–õ–ï–†–ï–Æ üé®";
                if (btn.mode === 'products') editBtnText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–û–í–ê–†–´ üõçÔ∏è";
                if (btn.mode === 'reviews') editBtnText = "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (AUTO)";

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] text-cyan-400">BUTTON ${idx+1}</span>
                        <div class="flex items-center">
                             ${upBtn}
                             ${downBtn}
                            <button onclick="removeMainMenuButton(${idx})" class="btn-delete-icon ml-2">‚úï</button>
                        </div>
                    </div>
                    <label class="admin-label">Icon & Color</label>
                    <div class="icon-grid" id="icon-grid-${idx}"></div>
                    <div class="color-row" id="color-row-${idx}"></div>
                    <input type="text" class="admin-input" value="${btn.title}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" onchange="tempAppData.mainMenu[${idx}].title=this.value">
                    <input type="text" class="admin-input" value="${btn.subtitle}" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫" onchange="tempAppData.mainMenu[${idx}].subtitle=this.value">
                    
                    <label class="admin-label mt-2">–†–µ–∂–∏–º –∫–Ω–æ–ø–∫–∏</label>
                    <select class="admin-select" onchange="tempAppData.mainMenu[${idx}].mode=this.value; renderAdminMainMenu();">
                        <option value="link" ${btn.mode==='link'?'selected':''}>–°—Å—ã–ª–∫–∞</option>
                        <option value="list" ${btn.mode==='list'?'selected':''}>–°–ø–∏—Å–æ–∫ (–ú–µ–Ω—é)</option>
                        <option value="gallery" ${btn.mode==='gallery'?'selected':''}>–ì–∞–ª–µ—Ä–µ—è</option>
                        <option value="products" ${btn.mode==='products'?'selected':''}>–í–∏—Ç—Ä–∏–Ω–∞ –¢–æ–≤–∞—Ä–æ–≤ üõçÔ∏è</option> <!-- NEW -->
                        <option value="reviews" ${btn.mode==='reviews'?'selected':''}>‚≠ê –û–¢–ó–´–í–´ (LIVE)</option>
                    </select>

                    ${btn.mode==='link' 
                        ? `<input type="text" class="admin-input mt-2" value="${btn.directLink||''}" placeholder="URL" onchange="tempAppData.mainMenu[${idx}].directLink=this.value">`
                        : (btn.mode === 'reviews' ? '' : `<button onclick="editSubList(${idx})" class="btn-edit-list">${editBtnText} (${btn.items?.length||0})</button>`)
                    }
                `;
                list.appendChild(div);
                renderIconPicker(idx);
            });
        }

        function moveMainMenuButton(index, direction) {
            const list = tempAppData.mainMenu;
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < list.length) {
                [list[index], list[newIndex]] = [list[newIndex], list[index]];
                renderAdminMainMenu();
            }
        }

        function renderIconPicker(idx) {
            const grid = document.getElementById(`icon-grid-${idx}`);
            const btn = tempAppData.mainMenu[idx];
            ICON_LIBRARY.forEach(icon => {
                const iBtn = document.createElement('button');
                iBtn.className = `icon-picker-btn ${btn.iconId === icon.id ? 'active' : ''}`;
                iBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icon.svg}</svg>`;
                iBtn.onclick = () => { 
                    tempAppData.mainMenu[idx].iconId = icon.id;
                    renderAdminMainMenu();
                };
                grid.appendChild(iBtn);
            });

            const colorRow = document.getElementById(`color-row-${idx}`);
            COLOR_LIBRARY.forEach(color => {
                const cBtn = document.createElement('button');
                cBtn.className = `color-picker-btn ${btn.iconColor === color.id ? 'active' : ''}`;
                cBtn.style.backgroundColor = color.hex;
                cBtn.onclick = () => {
                    tempAppData.mainMenu[idx].iconColor = color.id;
                    renderAdminMainMenu();
                };
                colorRow.appendChild(cBtn);
            });
        }

        function addNewMainMenuButton() {
            tempAppData.mainMenu.push({
                id: Date.now().toString(),
                title: "–ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞",
                subtitle: "–û–ø–∏—Å–∞–Ω–∏–µ",
                iconId: "bolt",
                iconColor: "text-blue-400",
                mode: "link",
                directLink: "",
                items: []
            });
            renderAdminMainMenu();
        }

        function removeMainMenuButton(idx) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { tempAppData.mainMenu.splice(idx, 1); renderAdminMainMenu(); }
        }

        function editSubList(idx) {
            currentEditingIndex = idx;
            document.getElementById('admin-content-main').classList.add('hidden');
            document.getElementById('admin-content-sublist').classList.remove('hidden');
            document.getElementById('admin-sublist-title').textContent = tempAppData.mainMenu[idx].title;
            
            // –°–ë–û–† –ö–ê–¢–ï–ì–û–†–ò–ô –î–õ–Ø –î–†–û–ü–î–ê–£–ù–ê
            availableCategories.clear();
            const items = tempAppData.mainMenu[idx].items || [];
            items.forEach(item => {
                if(item.category && item.category.trim()) {
                    availableCategories.add(item.category.trim());
                }
            });
            
            renderSubListItems();
        }

        // --- –£–¢–ò–õ–ò–¢–ê –°–ñ–ê–¢–ò–Ø –ö–ê–†–¢–ò–ù–û–ö ---
        function compressImage(file, callback) {
            const maxWidth = 800; // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –º–æ–±–∏–ª–æ–∫
            const quality = 0.6;  // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.getElementById('compress-canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // –°–∂–∏–º–∞–µ–º –≤ JPEG Base64
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    callback(dataUrl);
                };
            };
        }

        function handleFileUpload(input, idx) {
            const file = input.files[0];
            if (!file) return;
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∂–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤ input
            compressImage(file, (base64) => {
                if (base64.length > 700000) {
                   alert("–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–∞—è. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ø—Ä–æ—â–µ.");
                   return;
                }
                
                const parentMode = tempAppData.mainMenu[currentEditingIndex].mode;
                
                if (parentMode === 'products') {
                    // Logic for multiple images in products
                    // input id format: file-prod-${itemIdx}-${imgSlotIdx}
                    const slot = input.dataset.slot; 
                    if (!tempAppData.mainMenu[currentEditingIndex].items[idx].images) {
                        tempAppData.mainMenu[currentEditingIndex].items[idx].images = [];
                    }
                    // Ensure array is big enough
                    while(tempAppData.mainMenu[currentEditingIndex].items[idx].images.length <= slot) {
                         tempAppData.mainMenu[currentEditingIndex].items[idx].images.push('');
                    }
                    tempAppData.mainMenu[currentEditingIndex].items[idx].images[slot] = base64;
                } else {
                    // Default logic (Gallery)
                    tempAppData.mainMenu[currentEditingIndex].items[idx].imageUrl = base64;
                }
                
                renderSubListItems();
            });
        }

        function magicPaste(itemIdx) {
            const btn = document.getElementById(`btn-magic-${itemIdx}`);
            if(btn && btn.disabled) return;

            if(btn) {
                btn.disabled = true;
                btn.innerText = "‚è≥...";
            }
            
            isParsing = true;
            updateSaveButtons();
            
            const promptInput = document.getElementById(`prompt-area-${itemIdx}`);
            if(promptInput) promptInput.value = ''; 
            tempAppData.mainMenu[currentEditingIndex].items[itemIdx].imageUrl = "";
            tempAppData.mainMenu[currentEditingIndex].items[itemIdx].prompt = "";
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –±—ã–ª–∞
            tempAppData.mainMenu[currentEditingIndex].items[itemIdx].tgLink = "";
            
            const textArea = document.getElementById(`magic-paste-${itemIdx}`);
            const raw = textArea.value.trim();

            const showError = (msg) => {
                if(btn) {
                    btn.innerText = msg;
                    btn.style.color = '#ff4d4d'; 
                    setTimeout(() => {
                        if(btn) {
                            btn.innerText = "ü™Ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å";
                            btn.disabled = false;
                            btn.style.color = '';
                        }
                        isParsing = false;
                        updateSaveButtons();
                    }, 2000);
                }
            };
            
            if(!raw) return showError("–ü—É—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞!");

            const urlRegex = /(https:\/\/t\.me\/[\w\/]+)/;
            const match = raw.match(urlRegex);
            
            if (!match) return showError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!");

            const tgLink = match[0];
            const embedUrl = tgLink + '?embed=1&mode=tme';
            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(embedUrl);

            fetch(proxyUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    if (!data.contents) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data.contents, "text/html");

                    let extractedImg = "";
                    const photoWrap = doc.querySelector('.tgme_widget_message_photo_wrap');
                    if (photoWrap) {
                        const style = photoWrap.getAttribute('style');
                        const bgMatch = style.match(/url\('?(.*?)'?\)/);
                        if (bgMatch) extractedImg = bgMatch[1];
                    }

                    let extractedText = "";
                    const blockquote = doc.querySelector('.tgme_widget_message_text blockquote');
                    if (blockquote) {
                        extractedText = blockquote.innerText.trim();
                    } else {
                        const pre = doc.querySelector('.tgme_widget_message_text pre');
                        if (pre) extractedText = pre.innerText.trim();
                        else {
                            const code = doc.querySelector('.tgme_widget_message_text code');
                            if (code) extractedText = code.innerText.trim();
                            else {
                                const textDiv = doc.querySelector('.tgme_widget_message_text');
                                if (textDiv) extractedText = textDiv.innerText.trim();
                            }
                        }
                    }

                    if (!extractedImg && !extractedText) throw new Error("–ü—É—Å—Ç–æ");

                    if (extractedImg) tempAppData.mainMenu[currentEditingIndex].items[itemIdx].imageUrl = extractedImg;
                    if (extractedText) tempAppData.mainMenu[currentEditingIndex].items[itemIdx].prompt = extractedText;
                    
                    // –í–ê–ñ–ù–û: –°–û–•–†–ê–ù–Ø–ï–ú –ò–°–•–û–î–ù–£–Æ –°–°–´–õ–ö–£ –î–õ–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø
                    tempAppData.mainMenu[currentEditingIndex].items[itemIdx].tgLink = tgLink;

                    renderSubListItems();
                    const wrapper = document.getElementById(`item-wrapper-${itemIdx}`);
                    if(wrapper) wrapper.classList.add('flash-success');
                    
                    isParsing = false;
                    updateSaveButtons();
                    if(btn) {
                        btn.innerText = "–ì–æ—Ç–æ–≤–æ! ‚úÖ";
                        setTimeout(() => { btn.innerText = "ü™Ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å"; btn.disabled = false; }, 1500);
                    }
                })
                .catch(e => {
                    console.error(e);
                    showError("–û—à–∏–±–∫–∞");
                });
        }
        
        function updateSaveButtons() {
            const btnMain = document.getElementById('btn-save-global');
            const btnSub = document.getElementById('btn-save-sub');
            
            if(btnMain) btnMain.disabled = isParsing;
            if(btnSub) btnSub.disabled = isParsing;
        }
        
        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ì–õ–û–ë–ê–õ–¨–ù–û–ô –ö–ê–¢–ï–ì–û–†–ò–ò ---
        function addNewGlobalCategory() {
            const input = document.getElementById('new-cat-input');
            const val = input.value.trim();
            if(val) {
                availableCategories.add(val);
                input.value = '';
                renderSubListItems();
            }
        }

        function renderSubListItems() {
            const list = document.getElementById('admin-sublist-items');
            list.innerHTML = '';
            const parentBtn = tempAppData.mainMenu[currentEditingIndex];
            const items = parentBtn.items || [];
            const isGalleryMode = parentBtn.mode === 'gallery';
            const isProductMode = parentBtn.mode === 'products';
            
            // –î–û–ë–ê–í–õ–ï–ù –ë–õ–û–ö –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò –ï–°–õ–ò –ì–ê–õ–ï–†–ï–Ø
            if(isGalleryMode) {
                const catCreator = document.createElement('div');
                catCreator.className = 'admin-card mb-4';
                catCreator.style.background = 'rgba(255,255,255,0.05)';
                catCreator.innerHTML = `
                    <div class="admin-section-title text-green-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</div>
                    <div class="flex gap-2">
                        <input type="text" id="new-cat-input" class="admin-input" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è..." style="margin-bottom:0">
                        <button onclick="addNewGlobalCategory()" class="btn-add-cyber" style="width: auto; padding: 0 20px;">+</button>
                    </div>
                `;
                list.appendChild(catCreator);
            }
            
            items.forEach((item, idx) => {
                const total = items.length;
                const upBtn = idx > 0 ? `<button onclick="moveSubListItem(${idx}, -1)" class="text-xs text-gray-500 hover:text-white p-1">‚ñ≤</button>` : `<span class="p-1 w-4 block"></span>`;
                const downBtn = idx < total - 1 ? `<button onclick="moveSubListItem(${idx}, 1)" class="text-xs text-gray-500 hover:text-white p-1">‚ñº</button>` : `<span class="p-1 w-4 block"></span>`;

                const div = document.createElement('div');
                div.className = "guide-item-admin";
                div.id = `item-wrapper-${idx}`;

                if (isProductMode) {
                    // --- ADMIN FOR PRODUCTS ---
                    const images = item.images || [];
                    let imgPreviews = '';
                    for(let i=0; i<3; i++) {
                        const bg = images[i] ? `background-image: url('${images[i]}')` : '';
                        imgPreviews += `
                            <div class="relative w-16 h-16 bg-black/40 border border-white/20 rounded flex items-center justify-center overflow-hidden bg-cover bg-center" style="${bg}">
                                <input type="file" data-slot="${i}" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleFileUpload(this, ${idx})">
                                ${!images[i] ? '<span class="text-xs opacity-50">+</span>' : ''}
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                             <span class="text-[10px] text-purple-400 font-bold">PRODUCT ${idx+1}</span>
                             <div class="flex gap-2">
                                ${upBtn} ${downBtn}
                                <button onclick="tempAppData.mainMenu[${currentEditingIndex}].items.splice(${idx},1); renderSubListItems();" class="text-red-500 px-2">‚úï</button>
                             </div>
                        </div>
                        
                        <div class="flex gap-2 mb-2">
                             ${imgPreviews}
                        </div>
                        <div class="text-[9px] text-gray-500 mb-2">–ù–∞–∂–º–∏ –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å (–¥–æ 3 —Ñ–æ—Ç–æ)</div>

                        <input type="text" class="admin-input" value="${item.title || ''}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].title=this.value">
                        
                        <div class="flex gap-2">
                            <input type="text" class="admin-input" value="${item.price || ''}" placeholder="–¶–µ–Ω–∞ (1000 ‚ÇΩ)" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].price=this.value">
                            <input type="text" class="admin-input" value="${item.oldPrice || ''}" placeholder="–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (–Ω–µ–æ–±—è–∑.)" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].oldPrice=this.value">
                        </div>

                        <textarea class="admin-textarea h-16" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–∞ –≤–∏—Ç—Ä–∏–Ω—É)" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].description=this.value">${item.description || ''}</textarea>
                        <textarea class="admin-textarea h-24" placeholder="–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–≤ –∫–∞—Ä—Ç–æ—á–∫–µ)" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].fullDescription=this.value">${item.fullDescription || ''}</textarea>

                        <div class="flex gap-2 mt-2">
                            <div class="flex-1">
                                <label class="admin-label">–°—Ç–∞—Ç—É—Å</label>
                                <select class="admin-select" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].status=this.value">
                                    <option value="" ${!item.status ? 'selected' : ''}>–í –Ω–∞–ª–∏—á–∏–∏</option>
                                    <option value="sold" ${item.status === 'sold' ? 'selected' : ''}>–ü—Ä–æ–¥–∞–Ω–æ</option>
                                    <option value="wait" ${item.status === 'wait' ? 'selected' : ''}>–û–∂–∏–¥–∞–µ—Ç—Å—è</option>
                                    <option value="order" ${item.status === 'order' ? 'selected' : ''}>–ü–æ–¥ –∑–∞–∫–∞–∑</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="admin-label">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏</label>
                                <input type="text" class="admin-input" value="${item.buttonText || '–ö—É–ø–∏—Ç—å'}" placeholder="–ö—É–ø–∏—Ç—å" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].buttonText=this.value">
                            </div>
                        </div>
                        
                        <label class="admin-label">Telegram Username –ø—Ä–æ–¥–∞–≤—Ü–∞ (–±–µ–∑ @)</label>
                        <input type="text" class="admin-input" value="${item.buttonLink || ''}" placeholder="username" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].buttonLink=this.value">
                    `;

                } else if (isGalleryMode) {
                    const imgPreview = item.imageUrl ? 
                        `<div class="mb-2 mt-2 w-full h-32 bg-black rounded-lg overflow-hidden border border-white/10 relative">
                            <img src="${item.imageUrl}" class="w-full h-full object-contain">
                            <div class="absolute top-1 right-1 bg-green-500 text-[9px] text-white px-1 rounded">PREVIEW</div>
                         </div>` 
                        : '';

                    // –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–ü–¶–ò–ô –î–õ–Ø –°–ï–õ–ï–ö–¢–ê –ö–ê–¢–ï–ì–û–†–ò–ô
                    let optionsHtml = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    const sortedCats = Array.from(availableCategories).sort();
                    sortedCats.forEach(cat => {
                        const isSelected = item.category === cat ? 'selected' : '';
                        optionsHtml += `<option value="${cat}" ${isSelected}>${cat}</option>`;
                    });

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                             <span class="text-[10px] text-pink-400 font-bold">SLIDE ${idx+1}</span>
                             <div class="flex gap-2">
                                ${upBtn} ${downBtn}
                                <button onclick="tempAppData.mainMenu[${currentEditingIndex}].items.splice(${idx},1); renderSubListItems();" class="text-red-500 px-2">‚úï</button>
                             </div>
                        </div>
                        <div class="bg-white/5 p-2 rounded mb-2 border border-white/10">
                            <label class="admin-label text-purple-400">‚ú® Magic Paste (–∏–∑ Telegram)</label>
                            <div class="flex gap-2">
                                <textarea id="magic-paste-${idx}" class="admin-input h-8 text-[10px] mb-0" placeholder="https://t.me/..."></textarea>
                                <button id="btn-magic-${idx}" onclick="magicPaste(${idx})" class="magic-btn whitespace-nowrap">ü™Ñ OK</button>
                            </div>
                            <div class="text-[9px] text-gray-500 mt-1 pl-1">–ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Å—Å—ã–ª–∫–∏ —Å–∫—Ä–∏–ø—Ç —Ç–µ–ø–µ—Ä—å –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø–æ—Å—Ç –¥–ª—è –∞–≤—Ç–æ-–ª–µ—á–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏.</div>
                        </div>
                        
                        <div class="bg-blue-900/10 p-2 rounded mb-2 border border-blue-500/10">
                            <label class="admin-label text-blue-400">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–µ —Ñ–æ—Ç–æ (–í–µ—á–Ω–æ–µ)</label>
                            <input type="file" accept="image/*" class="text-xs text-gray-400 w-full" onchange="handleFileUpload(this, ${idx})">
                        </div>

                        ${imgPreview}
                        
                        <input type="text" class="admin-input hidden" value="${item.imageUrl || ''}" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ"> 
                        
                        <input type="text" class="admin-input" value="${item.title || ''}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].title=this.value">
                        
                        <!-- –ó–ê–ú–ï–ù–ï–ù–û –ù–ê –í–´–ü–ê–î–ê–Æ–©–ò–ô –°–ü–ò–°–û–ö -->
                        <label class="admin-label mt-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="admin-select" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].category=this.value">
                            ${optionsHtml}
                        </select>
                        
                        <textarea id="prompt-area-${idx}" class="admin-textarea" placeholder="–¢–µ–∫—Å—Ç..." onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].prompt=this.value">${item.prompt || ''}</textarea>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="flex gap-2 items-center">
                            <div class="flex flex-col gap-0 items-center justify-center mr-1">
                                ${upBtn}
                                ${downBtn}
                            </div>
                            <div class="flex-1">
                                <div class="flex gap-2 mb-2">
                                    <input type="text" class="admin-input flex-1" value="${item.title}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—É–Ω–∫—Ç–∞" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].title=this.value">
                                    <button onclick="tempAppData.mainMenu[${currentEditingIndex}].items.splice(${idx},1); renderSubListItems();" class="text-red-500 px-2">‚úï</button>
                                </div>
                                <input type="text" class="admin-input" value="${item.link}" placeholder="–°—Å—ã–ª–∫–∞" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].link=this.value">
                            </div>
                        </div>
                    `;
                }
                list.appendChild(div);
            });
        }

        function moveSubListItem(index, direction) {
            const list = tempAppData.mainMenu[currentEditingIndex].items;
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < list.length) {
                [list[index], list[newIndex]] = [list[newIndex], list[index]];
                renderSubListItems();
            }
        }

        function addNewSubItem() {
            const parentMode = tempAppData.mainMenu[currentEditingIndex].mode;
            let newItem = {};

            if (parentMode === 'products') {
                newItem = {
                    title: '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä',
                    description: '',
                    fullDescription: '',
                    price: '',
                    oldPrice: '',
                    status: '', // 'sold', 'wait', 'order'
                    images: [], // array of base64
                    buttonText: '–ö—É–ø–∏—Ç—å',
                    buttonLink: ''
                };
            } else {
                 newItem = { 
                    title: '–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç', 
                    link: '', 
                    icon: 'üìÑ',
                    imageUrl: '',
                    prompt: '',
                    category: '',
                    tgLink: ''
                };
            }
            
            // –ò–°–ü–û–õ–¨–ó–£–ï–ú UNSHIFT –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í –ù–ê–ß–ê–õ–û
            tempAppData.mainMenu[currentEditingIndex].items.unshift(newItem);
            renderSubListItems();
        }

        function backToMainAdmin() {
            document.getElementById('admin-content-sublist').classList.add('hidden');
            document.getElementById('admin-content-moderation').classList.add('hidden');
            document.getElementById('admin-content-main').classList.remove('hidden');
            renderAdminMainMenu();
        }

        function closeAdmin() { document.getElementById('admin-page').classList.replace('active-modal', 'hidden-bottom'); }

        async function saveAdminData() {
            if (tg.initDataUnsafe?.user?.id !== ADMIN_ID) return;
            if(isParsing) return tg.showAlert("–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏!");
            
            tempAppData.headerTitle = document.getElementById('admin-header-title').value;
            tempAppData.headerSubtitle = document.getElementById('admin-header-subtitle').value;
            await db.collection('configs').doc(configDocId).set(tempAppData);
            document.getElementById('save-status').style.opacity = '1';
            setTimeout(() => { document.getElementById('save-status').style.opacity = '0'; closeAdmin(); }, 1000);
        }

        // --- –ú–û–î–ï–†–ê–¶–ò–Ø ---
        function openModeration() {
            document.getElementById('admin-content-main').classList.add('hidden');
            document.getElementById('admin-content-moderation').classList.remove('hidden');
            loadModerationList();
        }

        function loadModerationList() {
            const list = document.getElementById('moderation-list');
            list.innerHTML = '<div class="text-center mt-4"><div class="spinner relative left-1/2 -ml-5"></div></div>';
            
            // –í–ê–ñ–ù–û: –£–±—Ä–∞–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ .orderBy('date', 'desc'), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ "Missing Index"
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–µ–ª–∞–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ. –≠—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.
            db.collection('reviews').get().then(snap => {
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<div class="text-center text-gray-500 text-sm mt-4">–û—Ç–∑—ã–≤–æ–≤ –Ω–µ—Ç.</div>';
                    return;
                }

                const pending = [];
                const approved = [];

                const docs = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    docs.push(data);
                });
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (—Å–≤–µ–∂–∏–µ —Å–≤–µ—Ä—Ö—É)
                docs.sort((a,b) => new Date(b.date) - new Date(a.date));

                docs.forEach(data => {
                    if (data.approved) approved.push(data);
                    else pending.push(data);
                });

                const renderCard = (r, isPending) => {
                    const card = document.createElement('div');
                    card.className = "guide-item-admin";
                    const stars = '‚òÖ'.repeat(r.rating);
                    
                    let buttons = '';
                    if (isPending) {
                        buttons = `
                            <button onclick="approveReview('${r.id}')" class="flex-1 bg-green-500/20 text-green-400 border border-green-500/50 rounded py-2 text-xs font-bold">–û–¥–æ–±—Ä–∏—Ç—å ‚úÖ</button>
                            <button onclick="deleteReview('${r.id}')" class="flex-1 bg-red-900/30 border border-red-500/50 text-red-500 rounded py-2 text-xs font-bold">–£–¥–∞–ª–∏—Ç—å üóëÔ∏è</button>
                        `;
                    } else {
                        buttons = `
                            <button onclick="deleteReview('${r.id}')" class="w-full bg-red-900/30 border border-red-500/50 text-red-500 rounded py-2 text-xs font-bold">–£–¥–∞–ª–∏—Ç—å (–£–∂–µ –Ω–∞ —Å–∞–π—Ç–µ) üóëÔ∏è</button>
                        `;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-cyan-400 font-bold text-xs">${escapeHtml(r.name)}</span>
                            <span class="text-yellow-400 text-xs">${stars}</span>
                        </div>
                        <div class="text-white text-xs mb-3 bg-black/20 p-2 rounded">${escapeHtml(r.text)}</div>
                        <div class="flex gap-2">
                            ${buttons}
                        </div>
                    `;
                    return card;
                };

                if (pending.length > 0) {
                    const title = document.createElement('div');
                    title.className = "text-yellow-400 text-xs font-bold mb-2 uppercase tracking-widest mt-4";
                    title.textContent = "–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏";
                    list.appendChild(title);
                    pending.forEach(r => list.appendChild(renderCard(r, true)));
                }

                if (approved.length > 0) {
                    const title = document.createElement('div');
                    title.className = "text-green-400 text-xs font-bold mb-2 uppercase tracking-widest mt-6";
                    title.textContent = "–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã (–ù–∞ —Å–∞–π—Ç–µ)";
                    list.appendChild(title);
                    approved.forEach(r => list.appendChild(renderCard(r, false)));
                }
            });
        }

        function approveReview(id) {
            if(!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?')) return;
            db.collection('reviews').doc(id).update({ approved: true }).then(() => {
                loadModerationList();
                tg.showAlert("–û—Ç–∑—ã–≤ –æ–¥–æ–±—Ä–µ–Ω! ‚úÖ");
            });
        }

        async function deleteReview(id) {
            if(!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª—è–µ–º —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?')) return;
            try {
                await db.collection('reviews').doc(id).delete();
                loadModerationList();
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>