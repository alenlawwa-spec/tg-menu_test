<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Navigation</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-color: #00f2ff;
            --neon-pink: #ff007a;
            --neon-green: #39ff14;
            --neon-yellow: #ffea00;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #050505;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            position: fixed;
            /* –ó–ê–©–ò–¢–ê –ö–û–ù–¢–ï–ù–¢–ê */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 20% 30%, #1a1033 0%, #050505 50%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: float 15s infinite alternate ease-in-out;
        }

        .orb-1 { width: 300px; height: 300px; background: var(--neon-color); top: -80px; right: -40px; }
        .orb-2 { width: 250px; height: 250px; background: var(--neon-pink); bottom: -60px; left: -40px; animation-delay: -3s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        .status-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
            transition: all 0.5s ease;
        }

        .status-dot.online {
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green);
            animation: pulse-green 2s infinite;
        }

        .status-dot.offline {
            animation: pulse-gray 2s infinite;
        }

        @keyframes pulse-green {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes pulse-gray { 0% { opacity: 0.5; } }

        /* –ê–ù–ò–ú–ê–¶–ò–Ø –£–°–ü–ï–•–ê */
        @keyframes flashGreen {
            0% { background-color: rgba(57, 255, 20, 0.3); border-color: var(--neon-green); }
            100% { background-color: rgba(255, 255, 255, 0.03); border-color: transparent; }
        }
        
        .flash-success {
            animation: flashGreen 1s ease-out;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 24px 20px calc(40px + env(safe-area-inset-bottom));
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .page::-webkit-scrollbar { width: 0px; }

        .hidden-left { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .hidden-right { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .hidden-bottom { transform: translateY(100%); opacity: 0; pointer-events: none; }
        .active { transform: translateX(0); opacity: 1; pointer-events: all; }
        .active-modal { transform: translateY(0); opacity: 1; pointer-events: all; }

        .glass-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 22px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }

        .glass-card:active {
            transform: scale(0.94);
            border-color: rgba(0, 242, 255, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        .admin-card {
            background: rgba(10, 10, 15, 0.8);
            border: 1px solid rgba(0, 242, 255, 0.15);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .admin-section-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--neon-color);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-section-title::after {
            content: '';
            height: 1px;
            flex: 1;
            background: linear-gradient(90deg, rgba(0, 242, 255, 0.3), transparent);
        }

        .guide-item-admin {
            background: rgba(255, 255, 255, 0.03);
            border-left: 2px solid var(--neon-pink);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
            transition: background-color 0.3s;
        }

        .admin-input, .admin-textarea {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .admin-textarea {
            resize: vertical;
            min-height: 60px;
        }

        .admin-label {
            font-size: 10px;
            color: #777;
            margin-bottom: 4px;
            margin-left: 4px;
            display: block;
            text-transform: uppercase;
        }

        .admin-select {
            width: 100%;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .icon-picker-btn {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-picker-btn.active {
            border-color: var(--neon-color);
            background: rgba(0, 242, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
        }

        .icon-picker-btn svg { width: 18px; height: 18px; }

        .color-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .color-picker-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .color-picker-btn.active {
            transform: scale(1.2);
            border-color: white;
        }

        .btn-delete-icon {
            color: rgba(255, 77, 77, 0.6);
            padding: 4px;
        }

        .btn-add-cyber {
            background: rgba(0, 242, 255, 0.05);
            color: var(--neon-color);
            border: 1px dashed rgba(0, 242, 255, 0.4);
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-save-cyber {
            background: linear-gradient(135deg, #0066ff, #00f2ff);
            color: white;
            font-weight: 700;
            padding: 14px;
            border-radius: 15px;
            width: 100%;
            margin-top: 10px;
            text-transform: uppercase;
        }
        
        .btn-save-cyber:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .btn-edit-list {
            background: rgba(255, 0, 122, 0.1);
            color: var(--neon-pink);
            border: 1px solid rgba(255, 0, 122, 0.3);
            border-radius: 10px;
            padding: 8px;
            width: 100%;
            font-size: 12px;
            margin-top: 5px;
        }

        .icon-box {
            width: 54px;
            height: 54px;
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 4px 4px 12px rgba(0,0,0,0.3);
            margin-right: 18px;
            flex-shrink: 0;
        }

        .icon-box svg { width: 26px; height: 26px; }

        .title-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #a1a1a1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Styles for Category Chips */
        .category-scroll-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 12px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .category-scroll-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .category-chip {
            white-space: nowrap;
            padding: 6px 16px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
            color: #ccc;
        }

        .category-chip.active {
            background: rgba(0, 242, 255, 0.15);
            color: var(--neon-color);
            border-color: rgba(0, 242, 255, 0.4);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-bottom: 80px;
        }

        .gallery-item {
            aspect-ratio: 3/4;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            background: #111;
        }

        .gallery-item:active { transform: scale(0.96); }

        .gallery-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-overlay {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 50%;
        }

        #gallery-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.98);
            backdrop-filter: blur(20px);
            z-index: 200;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #gallery-modal.active-modal {
            opacity: 1;
            pointer-events: all;
        }

        .gallery-modal-img-container {
            width: 100%;
            height: 55vh;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .gallery-modal-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .gallery-modal-content {
            flex-grow: 1;
            background: linear-gradient(to bottom, rgba(20, 20, 25, 1), rgba(10, 10, 15, 1));
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 24px 20px 100px 20px;
            display: flex;
            flex-direction: column;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            margin-top: -24px;
            position: relative;
            z-index: 10;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .quote-block {
            border-left: 3px solid var(--neon-pink);
            padding-left: 16px;
            margin-bottom: 16px;
            font-style: italic;
            color: #ccc;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .btn-copy {
            position: fixed;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: rgba(255, 0, 122, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 14px;
            border-radius: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 210;
            transition: transform 0.1s;
        }
        
        .btn-copy:active { transform: scale(0.96); }

        .magic-btn {
            background: linear-gradient(135deg, #7b2ff7, #2f88f7);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .magic-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--neon-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            z-index: 5;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .review-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .review-name { font-weight: 600; color: var(--neon-color); font-size: 14px; }
        .review-date { font-size: 10px; color: #888; }
        .review-text { font-size: 13px; line-height: 1.4; color: #ddd; word-wrap: break-word; }
        .stars { color: var(--neon-yellow); font-size: 12px; letter-spacing: 2px; }

        .btn-write-review {
            background: linear-gradient(90deg, #ff007a, #7b2ff7);
            color: white;
            font-weight: 600;
            padding: 14px;
            border-radius: 14px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(255, 0, 122, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        #review-write-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.95);
            backdrop-filter: blur(10px);
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 24px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
        }

        #review-write-modal.active-modal {
            opacity: 1;
            pointer-events: all;
        }

        .star-rating-input {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .star-rating-input input { display: none; }

        .star-rating-input label {
            font-size: 32px;
            color: #444;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating-input input:checked ~ label,
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label {
            color: var(--neon-yellow);
            text-shadow: 0 0 10px var(--neon-yellow);
        }

    </style>
</head>
<body>
    <div class="bg-glow">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <div class="status-container">
        <div id="status-dot" class="status-dot offline"></div>
    </div>

    <div id="main-page" class="page active">
        <header class="mb-10 mt-4 text-center">
            <h1 id="nav-header" class="text-3xl font-bold title-gradient tracking-tight select-none cursor-pointer">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h1>
            <p id="nav-subheader" class="text-gray-500 text-sm mt-2">–¢–≤–æ–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É</p>
        </header>

        <div id="main-menu-container" class="grid gap-4"></div>

        <footer class="mt-auto pt-16 pb-8 text-center">
            <p class="text-[10px] text-gray-600 opacity-50">Developed by Elena Sotnikova</p>
        </footer>
    </div>

    <div id="sub-page" class="page hidden-right">
        <header class="mb-6 mt-4 text-center relative">
             <button onclick="hideSubPage()" class="absolute left-0 top-1 text-2xl opacity-50 p-2">‚Äπ</button>
            <h1 id="sub-page-title" class="text-2xl font-bold title-gradient tracking-tight text-blue-400">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h1>
            <p id="sub-page-subtitle" class="text-gray-500 text-xs mt-1">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</p>
        </header>
        <div id="sub-page-container"></div>
        <div class="mt-auto h-20"></div> 
    </div>

    <div id="gallery-modal">
        <button onclick="closeGalleryModal()" class="absolute top-4 right-4 z-50 w-10 h-10 bg-black/50 rounded-full text-white flex items-center justify-center backdrop-blur-md">‚úï</button>
        <div class="gallery-modal-img-container" id="modal-img-wrapper"></div>
        <div class="gallery-modal-content">
            <div class="modal-text-wrapper">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-2 font-bold flex-shrink-0">PROMPT TEXT</div>
                <div class="quote-block" id="modal-prompt-text"></div>
            </div>
            <button onclick="copyCurrentPrompt()" class="btn-copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç ‚ú®
            </button>
        </div>
    </div>

    <div id="review-write-modal">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-white mb-2">–í–∞—à –æ—Ç–∑—ã–≤</h2>
            <p class="text-gray-400 text-xs">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏</p>
        </div>
        
        <label class="admin-label">–í–∞—à–µ –∏–º—è</label>
        <input type="text" id="review-name-input" class="admin-input bg-white/10" placeholder="–ò–º—è">
        
        <div class="star-rating-input">
            <input type="radio" id="star5" name="rating" value="5"><label for="star5">‚òÖ</label>
            <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÖ</label>
            <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÖ</label>
            <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÖ</label>
            <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÖ</label>
        </div>
        
        <textarea id="review-text-input" class="admin-textarea bg-white/10 mb-6" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–∏—è—Ç–Ω–æ–µ..."></textarea>
        
        <button onclick="submitReview()" class="btn-save-cyber">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ‚ú®</button>
        <button onclick="closeReviewModal()" class="text-gray-500 text-sm mt-4">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="admin-page" class="page hidden-bottom" style="background: rgba(5,5,8,0.98); z-index: 50; padding-bottom: 100px;">
        <header class="mb-8 flex justify-between items-center sticky top-0 bg-[#050508] py-4 z-20 border-b border-white/5">
            <div>
                <h2 class="text-2xl font-bold text-white tracking-tight">Terminal</h2>
                <div class="text-[10px] text-cyan-400 font-mono">ACCESS GRANTED // ADMIN_MODE</div>
            </div>
            <div class="flex gap-2">
                <button onclick="openModeration()" class="bg-blue-900/30 border border-blue-500/30 text-blue-400 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è</button>
                <button onclick="closeAdmin()" class="bg-white/5 w-10 h-10 rounded-full flex items-center justify-center text-gray-400">‚úï</button>
            </div>
        </header>

        <div id="admin-content-main" class="z-10">
            <div class="admin-card">
                <div class="admin-section-title">–ó–∞–≥–æ–ª–æ–≤–∫–∏ –ì–ª–∞–≤–Ω–æ–π</div>
                <div class="mb-2">
                    <label class="admin-label">–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="admin-header-title" class="admin-input">
                </div>
                <div>
                    <label class="admin-label">–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="admin-header-subtitle" class="admin-input">
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-section-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é</div>
                <div id="admin-main-menu-list" class="space-y-4"></div>
                <button onclick="addNewMainMenuButton()" class="btn-add-cyber mt-4">
                    <span>‚ö°</span> –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                </button>
            </div>
            
            <button onclick="saveAdminData()" id="btn-save-global" class="btn-save-cyber mt-4 mb-8" style="box-shadow: 0 4px 20px rgba(0, 242, 255, 0.2);">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>

        <div id="admin-content-sublist" class="hidden z-10 pb-24">
            <button onclick="backToMainAdmin()" class="text-gray-400 text-xs mb-4 flex items-center gap-2">‚Äπ –ù–∞–∑–∞–¥</button>
            
            <div class="admin-card">
                <div class="admin-section-title text-pink-500" id="admin-sublist-title">–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ø–∏—Å–∫–∞</div>
                
                <button onclick="addNewSubItem()" class="btn-add-cyber mb-2"><span>+</span> –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</button>
                <button onclick="saveAdminData()" id="btn-save-sub" class="btn-save-cyber mb-6" style="margin-top: 0; box-shadow: 0 4px 20px rgba(0, 242, 255, 0.2);">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                
                <div id="admin-sublist-items" class="space-y-4"></div>
            </div>
        </div>

        <div id="admin-content-moderation" class="hidden z-10">
             <button onclick="backToMainAdmin()" class="text-gray-400 text-xs mb-4 flex items-center gap-2">‚Äπ –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
             <div class="admin-section-title text-yellow-400">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</div>
             <div id="moderation-list" class="space-y-4 pb-20"></div>
        </div>

        <div id="save-status" class="text-center text-xs text-cyan-400 mt-4 opacity-0 transition-opacity font-mono">DB_SYNC_COMPLETE</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const ADMIN_ID = 758556732; 
        
        // –§–õ–ê–ì –ü–ê–†–°–ò–ù–ì–ê –î–õ–Ø –ë–õ–û–ö–ò–†–û–í–ö–ò –ö–ù–û–ü–û–ö
        let isParsing = false;

        // –ó–ê–©–ò–¢–ê –ü–†–ê–í–û–ô –ö–ù–û–ü–ö–ò
        document.addEventListener('contextmenu', event => event.preventDefault());

        const ICON_LIBRARY = [
            { id: 'folder', svg: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>' },
            { id: 'star', svg: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>' },
            { id: 'bolt', svg: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>' },
            { id: 'message', svg: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>' },
            { id: 'book', svg: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>' },
            { id: 'zap', svg: '<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>' },
            { id: 'instagram', svg: '<rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>' },
            { id: 'youtube', svg: '<path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>' },
            { id: 'telegram', svg: '<path d="M21.198 2.433a2.242 2.242 0 0 0-1.022.215l-16.5 6.75c-.92.376-.91 1.055-.16 1.43l4.33 1.353 10.033-6.326c.475-.29.911-.134.555.182l-8.13 7.34-.316 4.478c.438 0 .633-.2.88-.44l2.12-2.058 4.408 3.254c.438-.448 1.4.217 1.6-.758l2.9-13.68c.273-1.08-.41-1.574-1.108-1.23z"></path>' },
            { id: 'globe', svg: '<circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>' },
            { id: 'gift', svg: '<polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>' },
            { id: 'award', svg: '<circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>' }
        ];

        const COLOR_LIBRARY = [
            { id: 'text-blue-400', hex: '#00f2ff' },
            { id: 'text-pink-500', hex: '#ff007a' },
            { id: 'text-green-400', hex: '#39ff14' },
            { id: 'text-yellow-400', hex: '#ffea00' },
            { id: 'text-white', hex: '#ffffff' }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyCiYBslwEecbyuMyW5J05nvTs_sXLlurR4",
            authDomain: "tg-menu.firebaseapp.com",
            projectId: "tg-menu",
            storageBucket: "tg-menu.firebasestorage.app",
            messagingSenderId: "754545603793",
            appId: "1:754545603793:web:a466fd9b21a298a69d41f0"
        };

        const configDocId = "main_nav_v4_pro"; 
        let db, auth;
        let appData = { headerTitle: "–ù–∞–≤–∏–≥–∞—Ü–∏—è", headerSubtitle: "–¢–≤–æ–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫", mainMenu: [] };

        async function initApp() {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            await auth.signInAnonymously();
            
            db.collection('configs').doc(configDocId).onSnapshot((doc) => {
                if (doc.exists) {
                    appData = doc.data();
                    updateUI();
                    setOnlineStatus(true);
                }
            });
        }

        function setOnlineStatus(online) {
            const dot = document.getElementById('status-dot');
            if (dot) dot.className = `status-dot ${online ? 'online' : 'offline'}`;
        }

        function updateUI() {
            document.getElementById('nav-header').textContent = appData.headerTitle;
            document.getElementById('nav-subheader').textContent = appData.headerSubtitle;
            renderMainMenu();
        }

        function renderMainMenu() {
            const container = document.getElementById('main-menu-container');
            container.innerHTML = '';
            (appData.mainMenu || []).forEach((btn) => {
                const isComplexMode = btn.mode === 'list' || btn.mode === 'gallery' || btn.mode === 'reviews';
                
                const btnEl = document.createElement('div');
                btnEl.className = 'glass-card p-4 flex items-center cursor-pointer';
                btnEl.onclick = () => isComplexMode ? openSubPage(btn) : handleLink(btn.directLink);

                const iconSvg = ICON_LIBRARY.find(i => i.id === btn.iconId)?.svg || ICON_LIBRARY[2].svg;
                
                btnEl.innerHTML = `
                    <div class="icon-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="${btn.iconColor || 'text-white'}">
                            ${iconSvg}
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-white">${btn.title}</h3>
                        <p class="text-gray-400 text-xs text-white/60">${btn.subtitle}</p>
                    </div>
                    <div class="opacity-30 text-xl">‚Ä∫</div>
                `;
                container.appendChild(btnEl);
            });
        }

        // --- –õ–û–ì–ò–ö–ê –°–í–ê–ô–ü–ê ---
        let touchStartX = 0;
        const subPage = document.getElementById('sub-page');

        subPage.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        subPage.addEventListener('touchmove', e => {}, { passive: true });

        subPage.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].screenX;
            if (touchEndX - touchStartX > 50) {
                hideSubPage();
            }
        }, { passive: true });

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function loadReviews(container) {
            const reviewsList = document.createElement('div');
            reviewsList.id = 'reviews-public-list';
            reviewsList.innerHTML = '<div class="text-center mt-10"><div class="spinner relative left-1/2 -ml-5"></div></div>';
            container.appendChild(reviewsList);

            db.collection('reviews').where('approved', '==', true).get().then(snap => {
                reviewsList.innerHTML = '';
                const docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => new Date(b.date) - new Date(a.date));
                
                if(docs.length === 0) {
                    reviewsList.innerHTML = '<div class="text-center text-gray-500 text-sm mt-4">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</div>';
                    return;
                }

                docs.forEach(r => {
                    const card = document.createElement('div');
                    card.className = 'review-card animate-pulse-enter';
                    const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5 - r.rating);
                    const dateStr = new Date(r.date).toLocaleDateString();
                    card.innerHTML = `
                        <div class="review-header">
                            <span class="review-name">${escapeHtml(r.name)}</span>
                            <span class="stars">${stars}</span>
                        </div>
                        <div class="review-text">${escapeHtml(r.text)}</div>
                        <div class="review-date mt-2 text-right opacity-50 text-[9px]">${dateStr}</div>
                    `;
                    reviewsList.appendChild(card);
                });
            });
        }

        function openSubPage(btnData) {
            tg.HapticFeedback.impactOccurred('medium');
            document.getElementById('sub-page-title').textContent = btnData.title;
            document.getElementById('sub-page-subtitle').textContent = btnData.subtitle;
            const container = document.getElementById('sub-page-container');
            container.innerHTML = '';

            if (btnData.mode === 'gallery') {
                // --- –õ–û–ì–ò–ö–ê –ì–ê–õ–ï–†–ï–ò –° –§–ò–õ–¨–¢–†–ê–ú–ò ---
                const allItems = btnData.items || [];
                
                // 1. –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const categories = ['–í—Å–µ', ...new Set(allItems.map(i => i.category).filter(Boolean))];
                
                // 2. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
                if (categories.length > 1) {
                    const filterContainer = document.createElement('div');
                    filterContainer.className = 'category-scroll-container';
                    
                    categories.forEach(cat => {
                        const chip = document.createElement('div');
                        chip.className = `category-chip ${cat === '–í—Å–µ' ? 'active' : ''}`;
                        chip.textContent = cat;
                        chip.onclick = (e) => {
                            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
                            document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
                            e.target.classList.add('active');
                            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                            renderGalleryItems(cat === '–í—Å–µ' ? allItems : allItems.filter(i => i.category === cat), gridContainer);
                            tg.HapticFeedback.selectionChanged();
                        };
                        filterContainer.appendChild(chip);
                    });
                    container.appendChild(filterContainer);
                }

                // 3. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–µ—Ç–∫–∏
                const gridContainer = document.createElement('div');
                gridContainer.className = 'gallery-grid animate-pulse-enter';
                container.appendChild(gridContainer);
                
                // 4. –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                renderGalleryItems(allItems, gridContainer);
            } 
            else if (btnData.mode === 'reviews') {
                container.className = 'flex flex-col pb-20';
                
                const btn = document.createElement('button');
                btn.className = 'btn-write-review';
                btn.innerHTML = '‚ú® –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤';
                btn.onclick = openReviewModal;
                container.appendChild(btn);
                
                loadReviews(container);
            }
            else {
                container.className = 'grid gap-4'; 
                (btnData.items || []).forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'glass-card p-4 flex items-center cursor-pointer';
                    itemEl.onclick = () => handleLink(item.link);
                    itemEl.innerHTML = `<div class="icon-box text-blue-300 text-xl">${item.icon || 'üìÑ'}</div><div class="flex-1 text-white font-medium">${item.title}</div><div class="opacity-30 text-xl">‚Ä∫</div>`;
                    container.appendChild(itemEl);
                });
            }

            document.getElementById('main-page').classList.replace('active', 'hidden-left');
            subPage.classList.replace('hidden-right', 'active');
            tg.BackButton.show();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –≥–∞–ª–µ—Ä–µ–∏
        function renderGalleryItems(items, container) {
            container.innerHTML = '';
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'gallery-item cursor-pointer animate-pulse-enter';
                itemEl.onclick = () => openGalleryModal(item.imageUrl, item.prompt);
                itemEl.innerHTML = `
                    <img src="${item.imageUrl}" class="gallery-img" referrerpolicy="no-referrer" onerror="this.src='https://placehold.co/400x600/222/555?text=No+Img'">
                    <div class="gallery-overlay pointer-events-none">
                        <div class="text-[10px] text-pink-500 font-bold uppercase tracking-wider mb-1">PROMPT</div>
                        <div class="text-white text-xs font-semibold truncate">${item.title || 'Untitled'}</div>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        function hideSubPage() {
            subPage.classList.replace('active', 'hidden-right');
            document.getElementById('main-page').classList.replace('hidden-left', 'active');
            tg.BackButton.hide();
        }

        tg.BackButton.onClick(() => {
            const galleryModal = document.getElementById('gallery-modal');
            if (galleryModal.classList.contains('active-modal')) {
                closeGalleryModal();
            } else {
                hideSubPage();
            }
        });

        function handleLink(url) {
            if (!url) return;
            tg.HapticFeedback.impactOccurred('light');
            if (url.includes('t.me/')) {
                tg.openTelegramLink(url);
            } else {
                tg.openLink(url, { try_instant_view: true });
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –û–¢–ó–´–í–û–í ---
        function openReviewModal() {
            const nameInput = document.getElementById('review-name-input');
            const userFirstName = tg.initDataUnsafe?.user?.first_name || "–ì–æ—Å—Ç—å";
            if(!nameInput.value) nameInput.value = userFirstName;
            document.getElementById('review-write-modal').classList.add('active-modal');
        }

        function closeReviewModal() {
            document.getElementById('review-write-modal').classList.remove('active-modal');
        }

        function submitReview() {
            const name = document.getElementById('review-name-input').value;
            const text = document.getElementById('review-text-input').value;
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            
            if(!ratingEl) return tg.showAlert("–ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É! ‚≠ê");
            if(!text) return tg.showAlert("–ù–∞–ø–∏—à–∏—Ç–µ —Ö–æ—Ç—å –ø–∞—Ä—É —Å–ª–æ–≤...");
            
            const rating = parseInt(ratingEl.value);
            
            db.collection('reviews').add({
                name: name,
                text: text,
                rating: rating,
                approved: false, // –ü—Ä–µ-–º–æ–¥–µ—Ä–∞—Ü–∏—è
                date: new Date().toISOString(),
                userId: tg.initDataUnsafe?.user?.id || 'anon'
            }).then(() => {
                closeReviewModal();
                tg.showAlert("–í–∞—à –æ—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é! ‚ú®");
                document.getElementById('review-text-input').value = '';
                document.querySelectorAll('input[name="rating"]').forEach(el => el.checked = false);
            });
        }

        // --- –ì–ê–õ–ï–†–ï–Ø –ú–û–î–ê–õ–ö–ê ---
        function openGalleryModal(imgUrl, promptText) {
            tg.HapticFeedback.impactOccurred('medium');
            const modal = document.getElementById('gallery-modal');
            const wrapper = document.getElementById('modal-img-wrapper');
            wrapper.innerHTML = '';

            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            wrapper.appendChild(spinner);

            const img = document.createElement('img');
            img.src = imgUrl;
            img.className = "gallery-modal-img";
            img.referrerPolicy = "no-referrer";
            img.style.opacity = "0";
            img.onload = () => {
                spinner.remove();
                img.style.transition = "opacity 0.3s";
                img.style.opacity = "1";
            };
            img.onerror = function() {
                spinner.remove();
                this.src = 'https://placehold.co/400x600/222/555?text=Error+Loading';
                this.style.opacity = "1";
            };
            wrapper.appendChild(img);
            
            const grad = document.createElement('div');
            grad.className = "absolute bottom-0 inset-x-0 h-24 bg-gradient-to-t from-[#141419] to-transparent pointer-events-none";
            wrapper.appendChild(grad);

            document.getElementById('modal-prompt-text').textContent = promptText || "–ù–µ—Ç –ø—Ä–æ–º–ø—Ç–∞";
            modal.classList.add('active-modal');
        }

        function closeGalleryModal() {
            document.getElementById('gallery-modal').classList.remove('active-modal');
            setTimeout(() => {
                 document.getElementById('modal-img-wrapper').innerHTML = '';
            }, 300);
        }

        function copyCurrentPrompt() {
            const text = document.getElementById('modal-prompt-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                tg.showAlert('–ü—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                tg.HapticFeedback.notificationOccurred('success');
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                tg.showAlert('–ü—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            });
        }

        // --- –ê–î–ú–ò–ù–ö–ê ---
        let tapCount = 0;
        document.getElementById('nav-header').addEventListener('click', () => {
            tapCount++;
            if (tapCount >= 5) {
                if (tg.initDataUnsafe?.user?.id !== ADMIN_ID) return;
                openAdmin(); 
                tapCount = 0;
            }
            setTimeout(() => tapCount = 0, 1000);
        });

        let tempAppData = null;
        let currentEditingIndex = null;

        function openAdmin() {
            tempAppData = JSON.parse(JSON.stringify(appData));
            document.getElementById('admin-header-title').value = tempAppData.headerTitle;
            document.getElementById('admin-header-subtitle').value = tempAppData.headerSubtitle;
            renderAdminMainMenu();
            document.getElementById('admin-page').classList.replace('hidden-bottom', 'active-modal');
            document.getElementById('admin-content-main').classList.remove('hidden');
            document.getElementById('admin-content-sublist').classList.add('hidden');
            document.getElementById('admin-content-moderation').classList.add('hidden');
        }

        function renderAdminMainMenu() {
            const list = document.getElementById('admin-main-menu-list');
            list.innerHTML = '';
            const total = tempAppData.mainMenu.length;
            tempAppData.mainMenu.forEach((btn, idx) => {
                const div = document.createElement('div');
                div.className = "guide-item-admin";

                const upBtn = idx > 0 ? `<button onclick="moveMainMenuButton(${idx}, -1)" class="px-2 text-gray-500 hover:text-cyan-400 transition">‚ñ≤</button>` : `<span class="px-2 opacity-0">‚ñ≤</span>`;
                const downBtn = idx < total - 1 ? `<button onclick="moveMainMenuButton(${idx}, 1)" class="px-2 text-gray-500 hover:text-cyan-400 transition">‚ñº</button>` : `<span class="px-2 opacity-0">‚ñº</span>`;

                let editBtnText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫";
                if (btn.mode === 'gallery') editBtnText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ì–ê–õ–ï–†–ï–Æ üé®";
                if (btn.mode === 'reviews') editBtnText = "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (AUTO)";

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] text-cyan-400">BUTTON ${idx+1}</span>
                        <div class="flex items-center">
                             ${upBtn}
                             ${downBtn}
                            <button onclick="removeMainMenuButton(${idx})" class="btn-delete-icon ml-2">‚úï</button>
                        </div>
                    </div>
                    <label class="admin-label">Icon & Color</label>
                    <div class="icon-grid" id="icon-grid-${idx}"></div>
                    <div class="color-row" id="color-row-${idx}"></div>
                    <input type="text" class="admin-input" value="${btn.title}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" onchange="tempAppData.mainMenu[${idx}].title=this.value">
                    <input type="text" class="admin-input" value="${btn.subtitle}" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫" onchange="tempAppData.mainMenu[${idx}].subtitle=this.value">
                    
                    <label class="admin-label mt-2">–†–µ–∂–∏–º –∫–Ω–æ–ø–∫–∏</label>
                    <select class="admin-select" onchange="tempAppData.mainMenu[${idx}].mode=this.value; renderAdminMainMenu();">
                        <option value="link" ${btn.mode==='link'?'selected':''}>–°—Å—ã–ª–∫–∞</option>
                        <option value="list" ${btn.mode==='list'?'selected':''}>–°–ø–∏—Å–æ–∫ (–ú–µ–Ω—é)</option>
                        <option value="gallery" ${btn.mode==='gallery'?'selected':''}>–ì–∞–ª–µ—Ä–µ—è –ü—Ä–æ–º–ø—Ç–æ–≤ ‚ú®</option>
                        <option value="reviews" ${btn.mode==='reviews'?'selected':''}>‚≠ê –û–¢–ó–´–í–´ (LIVE)</option>
                    </select>

                    ${btn.mode==='link' 
                        ? `<input type="text" class="admin-input mt-2" value="${btn.directLink||''}" placeholder="URL" onchange="tempAppData.mainMenu[${idx}].directLink=this.value">`
                        : (btn.mode === 'reviews' ? '' : `<button onclick="editSubList(${idx})" class="btn-edit-list">${editBtnText} (${btn.items?.length||0})</button>`)
                    }
                `;
                list.appendChild(div);
                renderIconPicker(idx);
            });
        }

        function moveMainMenuButton(index, direction) {
            const list = tempAppData.mainMenu;
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < list.length) {
                [list[index], list[newIndex]] = [list[newIndex], list[index]];
                renderAdminMainMenu();
            }
        }

        function renderIconPicker(idx) {
            const grid = document.getElementById(`icon-grid-${idx}`);
            const btn = tempAppData.mainMenu[idx];
            ICON_LIBRARY.forEach(icon => {
                const iBtn = document.createElement('button');
                iBtn.className = `icon-picker-btn ${btn.iconId === icon.id ? 'active' : ''}`;
                iBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icon.svg}</svg>`;
                iBtn.onclick = () => { 
                    tempAppData.mainMenu[idx].iconId = icon.id;
                    renderAdminMainMenu();
                };
                grid.appendChild(iBtn);
            });

            const colorRow = document.getElementById(`color-row-${idx}`);
            COLOR_LIBRARY.forEach(color => {
                const cBtn = document.createElement('button');
                cBtn.className = `color-picker-btn ${btn.iconColor === color.id ? 'active' : ''}`;
                cBtn.style.backgroundColor = color.hex;
                cBtn.onclick = () => {
                    tempAppData.mainMenu[idx].iconColor = color.id;
                    renderAdminMainMenu();
                };
                colorRow.appendChild(cBtn);
            });
        }

        function addNewMainMenuButton() {
            tempAppData.mainMenu.push({
                id: Date.now().toString(),
                title: "–ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞",
                subtitle: "–û–ø–∏—Å–∞–Ω–∏–µ",
                iconId: "bolt",
                iconColor: "text-blue-400",
                mode: "link",
                directLink: "",
                items: []
            });
            renderAdminMainMenu();
        }

        function removeMainMenuButton(idx) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { tempAppData.mainMenu.splice(idx, 1); renderAdminMainMenu(); }
        }

        function editSubList(idx) {
            currentEditingIndex = idx;
            document.getElementById('admin-content-main').classList.add('hidden');
            document.getElementById('admin-content-sublist').classList.remove('hidden');
            document.getElementById('admin-sublist-title').textContent = tempAppData.mainMenu[idx].title;
            renderSubListItems();
        }

        // --- –§–£–ù–ö–¶–ò–ò –ú–û–î–ï–†–ê–¶–ò–ò ---
        function openModeration() {
            document.getElementById('admin-content-main').classList.add('hidden');
            document.getElementById('admin-content-moderation').classList.remove('hidden');
            loadModerationList();
        }

        function loadModerationList() {
            const list = document.getElementById('moderation-list');
            list.innerHTML = '<div class="text-center mt-4"><div class="spinner relative left-1/2 -ml-5"></div></div>';
            
            db.collection('reviews').orderBy('date', 'desc').get().then(snap => {
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<div class="text-center text-gray-500 text-sm mt-4">–û—Ç–∑—ã–≤–æ–≤ –Ω–µ—Ç.</div>';
                    return;
                }

                const pending = [];
                const approved = [];

                snap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    if (data.approved) approved.push(data);
                    else pending.push(data);
                });

                const renderCard = (r, isPending) => {
                    const card = document.createElement('div');
                    card.className = "guide-item-admin";
                    const stars = '‚òÖ'.repeat(r.rating);
                    
                    let buttons = '';
                    if (isPending) {
                        buttons = `
                            <button onclick="approveReview('${r.id}')" class="flex-1 bg-green-500/20 text-green-400 border border-green-500/50 rounded py-2 text-xs font-bold">–û–¥–æ–±—Ä–∏—Ç—å ‚úÖ</button>
                            <button onclick="deleteReview('${r.id}')" class="flex-1 bg-red-900/30 border border-red-500/50 text-red-500 rounded py-2 text-xs font-bold">–£–¥–∞–ª–∏—Ç—å üóëÔ∏è</button>
                        `;
                    } else {
                        buttons = `
                            <button onclick="deleteReview('${r.id}')" class="w-full bg-red-900/30 border border-red-500/50 text-red-500 rounded py-2 text-xs font-bold">–£–¥–∞–ª–∏—Ç—å (–£–∂–µ –Ω–∞ —Å–∞–π—Ç–µ) üóëÔ∏è</button>
                        `;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-cyan-400 font-bold text-xs">${escapeHtml(r.name)}</span>
                            <span class="text-yellow-400 text-xs">${stars}</span>
                        </div>
                        <div class="text-white text-xs mb-3 bg-black/20 p-2 rounded">${escapeHtml(r.text)}</div>
                        <div class="flex gap-2">
                            ${buttons}
                        </div>
                    `;
                    return card;
                };

                if (pending.length > 0) {
                    const title = document.createElement('div');
                    title.className = "text-yellow-400 text-xs font-bold mb-2 uppercase tracking-widest mt-4";
                    title.textContent = "–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏";
                    list.appendChild(title);
                    pending.forEach(r => list.appendChild(renderCard(r, true)));
                }

                if (approved.length > 0) {
                    const title = document.createElement('div');
                    title.className = "text-green-400 text-xs font-bold mb-2 uppercase tracking-widest mt-6";
                    title.textContent = "–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã (–ù–∞ —Å–∞–π—Ç–µ)";
                    list.appendChild(title);
                    approved.forEach(r => list.appendChild(renderCard(r, false)));
                }
            });
        }

        function approveReview(id) {
            if(!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?')) return;
            db.collection('reviews').doc(id).update({ approved: true }).then(() => {
                loadModerationList();
                tg.showAlert("–û—Ç–∑—ã–≤ –æ–¥–æ–±—Ä–µ–Ω! ‚úÖ");
            });
        }

        async function deleteReview(id) {
            if(!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª—è–µ–º —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?')) return;
            try {
                await db.collection('reviews').doc(id).delete();
                alert('–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ! üíÄ');
                loadModerationList();
            } catch (e) {
                console.error(e);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        // --- –ú–ê–ì–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
        async function magicPaste(itemIdx) {
            const btn = document.getElementById(`btn-magic-${itemIdx}`);
            if(btn && btn.disabled) return;

            if(btn) {
                btn.disabled = true;
                btn.innerText = "‚è≥...";
            }
            
            isParsing = true;
            updateSaveButtons();
            
            const promptInput = document.getElementById(`prompt-area-${itemIdx}`);
            if(promptInput) promptInput.value = ''; 
            tempAppData.mainMenu[currentEditingIndex].items[itemIdx].imageUrl = "";
            tempAppData.mainMenu[currentEditingIndex].items[itemIdx].prompt = "";
            
            const textArea = document.getElementById(`magic-paste-${itemIdx}`);
            const raw = textArea.value.trim();

            const showError = (msg) => {
                if(btn) {
                    btn.innerText = msg;
                    btn.style.color = '#ff4d4d'; 
                    setTimeout(() => {
                        if(btn) {
                            btn.innerText = "ü™Ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å";
                            btn.disabled = false;
                            btn.style.color = '';
                        }
                        isParsing = false;
                        updateSaveButtons();
                    }, 2000);
                }
            };
            
            if(!raw) return showError("–ü—É—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞!");

            const urlRegex = /(https:\/\/t\.me\/[\w\/]+)/;
            const match = raw.match(urlRegex);
            
            if (!match) return showError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!");

            const tgLink = match[0];
            const embedUrl = tgLink + '?embed=1&mode=tme';
            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(embedUrl);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 7000);

            try {
                const response = await fetch(proxyUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) throw new Error("Network response was not ok");
                
                const data = await response.json();
                if (!data.contents) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, "text/html");

                let extractedImg = "";
                const photoWrap = doc.querySelector('.tgme_widget_message_photo_wrap');
                if (photoWrap) {
                    const style = photoWrap.getAttribute('style');
                    const bgMatch = style.match(/url\('?(.*?)'?\)/);
                    if (bgMatch) extractedImg = bgMatch[1];
                }

                let extractedText = "";
                const blockquote = doc.querySelector('.tgme_widget_message_text blockquote');
                if (blockquote) {
                    extractedText = blockquote.innerText.trim();
                } else {
                    const pre = doc.querySelector('.tgme_widget_message_text pre');
                    if (pre) {
                         extractedText = pre.innerText.trim();
                    } else {
                        const code = doc.querySelector('.tgme_widget_message_text code');
                        if (code) {
                             extractedText = code.innerText.trim();
                        } else {
                            const textDiv = doc.querySelector('.tgme_widget_message_text');
                            if (textDiv) extractedText = textDiv.innerText.trim();
                        }
                    }
                }

                if (!extractedImg && !extractedText) {
                    throw new Error("–ü—É—Å—Ç–æ");
                }

                if (extractedImg) tempAppData.mainMenu[currentEditingIndex].items[itemIdx].imageUrl = extractedImg;
                if (extractedText) tempAppData.mainMenu[currentEditingIndex].items[itemIdx].prompt = extractedText;

                renderSubListItems();
                
                const wrapper = document.getElementById(`item-wrapper-${itemIdx}`);
                if(wrapper) wrapper.classList.add('flash-success');
                
                isParsing = false;
                updateSaveButtons();

            } catch (e) {
                console.error(e);
                clearTimeout(timeoutId); 
                if (e.name === 'AbortError') {
                    showError("–î–æ–ª–≥–æ –æ—Ç–≤–µ—á–∞–µ—Ç");
                } else {
                    showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
                }
            }
        }

        function resetMagicState(btn) {
            isParsing = false;
            updateSaveButtons();
            if(btn) { btn.disabled = false; btn.innerText = "ü™Ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å"; }
        }
        
        function updateSaveButtons() {
            const btnMain = document.getElementById('btn-save-global');
            const btnSub = document.getElementById('btn-save-sub');
            
            if(btnMain) btnMain.disabled = isParsing;
            if(btnSub) btnSub.disabled = isParsing;
        }

        function renderSubListItems() {
            const list = document.getElementById('admin-sublist-items');
            list.innerHTML = '';
            const parentBtn = tempAppData.mainMenu[currentEditingIndex];
            const items = parentBtn.items || [];
            const isGalleryMode = parentBtn.mode === 'gallery';
            
            items.forEach((item, idx) => {
                const total = items.length;
                const upBtn = idx > 0 ? `<button onclick="moveSubListItem(${idx}, -1)" class="text-xs text-gray-500 hover:text-white p-1">‚ñ≤</button>` : `<span class="p-1 w-4 block"></span>`;
                const downBtn = idx < total - 1 ? `<button onclick="moveSubListItem(${idx}, 1)" class="text-xs text-gray-500 hover:text-white p-1">‚ñº</button>` : `<span class="p-1 w-4 block"></span>`;

                const div = document.createElement('div');
                div.className = "guide-item-admin";
                div.id = `item-wrapper-${idx}`;

                if (isGalleryMode) {
                    const imgPreview = item.imageUrl ? 
                        `<div class="mb-2 mt-2 w-full h-32 bg-black rounded-lg overflow-hidden border border-white/10 relative">
                            <img src="${item.imageUrl}" class="w-full h-full object-contain">
                            <div class="absolute top-1 right-1 bg-green-500 text-[9px] text-white px-1 rounded">PREVIEW</div>
                         </div>` 
                        : '';

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                             <span class="text-[10px] text-pink-400 font-bold">SLIDE ${idx+1}</span>
                             <div class="flex gap-2">
                                ${upBtn} ${downBtn}
                                <button onclick="tempAppData.mainMenu[${currentEditingIndex}].items.splice(${idx},1); renderSubListItems();" class="text-red-500 px-2">‚úï</button>
                             </div>
                        </div>
                        <div class="bg-white/5 p-2 rounded mb-2 border border-white/10">
                            <label class="admin-label text-purple-400">‚ú® Magic Paste (–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç)</label>
                            <textarea id="magic-paste-${idx}" class="admin-input h-10 text-[10px]" placeholder="https://t.me/channel/123"></textarea>
                            <button id="btn-magic-${idx}" onclick="magicPaste(${idx})" class="magic-btn">ü™Ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å</button>
                        </div>
                        ${imgPreview}
                        <input type="text" class="admin-input" value="${item.title || ''}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].title=this.value">
                        <input type="text" class="admin-input" value="${item.imageUrl || ''}" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].imageUrl=this.value">
                        <input type="text" class="admin-input" value="${item.category || ''}" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –§—ç–Ω—Ç–µ–∑–∏)" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].category=this.value">
                        <textarea id="prompt-area-${idx}" class="admin-textarea" placeholder="–¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞..." onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].prompt=this.value">${item.prompt || ''}</textarea>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="flex gap-2 items-center">
                            <div class="flex flex-col gap-0 items-center justify-center mr-1">
                                ${upBtn}
                                ${downBtn}
                            </div>
                            <div class="flex-1">
                                <div class="flex gap-2 mb-2">
                                    <input type="text" class="admin-input w-12 text-center" value="${item.icon}" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].icon=this.value">
                                    <input type="text" class="admin-input flex-1" value="${item.title}" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].title=this.value">
                                    <button onclick="tempAppData.mainMenu[${currentEditingIndex}].items.splice(${idx},1); renderSubListItems();" class="text-red-500 px-2">‚úï</button>
                                </div>
                                <input type="text" class="admin-input" value="${item.link}" placeholder="URL" onchange="tempAppData.mainMenu[${currentEditingIndex}].items[${idx}].link=this.value">
                            </div>
                        </div>
                    `;
                }
                list.appendChild(div);
            });
        }

        function moveSubListItem(index, direction) {
            const list = tempAppData.mainMenu[currentEditingIndex].items;
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < list.length) {
                [list[index], list[newIndex]] = [list[newIndex], list[index]];
                renderSubListItems();
            }
        }

        function addNewSubItem() {
            // –ò–°–ü–û–õ–¨–ó–£–ï–ú UNSHIFT –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í –ù–ê–ß–ê–õ–û
            tempAppData.mainMenu[currentEditingIndex].items.unshift({ 
                title: '–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç', 
                link: '', 
                icon: 'üìÑ',
                imageUrl: '',
                prompt: '',
                category: ''
            });
            renderSubListItems();
        }

        function backToMainAdmin() {
            document.getElementById('admin-content-sublist').classList.add('hidden');
            document.getElementById('admin-content-moderation').classList.add('hidden');
            document.getElementById('admin-content-main').classList.remove('hidden');
            renderAdminMainMenu();
        }

        function closeAdmin() { document.getElementById('admin-page').classList.replace('active-modal', 'hidden-bottom'); }

        async function saveAdminData() {
            if (tg.initDataUnsafe?.user?.id !== ADMIN_ID) return;
            if(isParsing) return tg.showAlert("–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏!");
            
            tempAppData.headerTitle = document.getElementById('admin-header-title').value;
            tempAppData.headerSubtitle = document.getElementById('admin-header-subtitle').value;
            await db.collection('configs').doc(configDocId).set(tempAppData);
            document.getElementById('save-status').style.opacity = '1';
            setTimeout(() => { document.getElementById('save-status').style.opacity = '0'; closeAdmin(); }, 1000);
        }

        function saveSubList() { backToMainAdmin(); }

        initApp();
        tg.ready();
    </script>
</body>
</html>